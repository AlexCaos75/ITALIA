<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />

  <link rel="icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico">

  <title>Quiz Regioni Italia + Cultura, Arte, Musica, Cucina, Spettacolo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a73e8, #3c8dbc);
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background-repeat: no-repeat;
      background-size: cover;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(255 255 255 / 0.1) 0%, transparent 70%),
        radial-gradient(circle at 80% 80%, rgba(255 255 255 / 0.1) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    h1 { margin: 1rem; z-index: 1; text-shadow: 0 0 10px rgba(0,0,0,0.7); }
    .visually-hidden {
      position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
    }
    @keyframes blinkFast {
      0%,100% { opacity: 1; color: #ff0; text-shadow: 0 0 10px #ff0; }
      50% { opacity: 0.5; color: #f00; text-shadow: 0 0 20px #f00; }
    }
    @keyframes blinkX { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    text.completed-marker {
      fill: white; font-size: 16px; font-weight: 700; text-anchor: middle; pointer-events: none;
      animation: blinkX 1s infinite alternate;
    }
    #map-container { position: relative; width: 90vw; max-width: 900px; aspect-ratio: 5 / 7; margin-bottom: 2rem; z-index: 1; }
    #map-container img {
      width: 100%; height: 100%; object-fit: contain; display: block; filter: brightness(0.85) contrast(1.15);
      border-radius: 18px; box-shadow: 0 0 30px rgba(0,0,0,0.7);
    }
    #map-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #map-svg g { pointer-events: auto; cursor: pointer; transition: transform 0.25s ease; }
    #map-svg circle {
      r: 12; transition: r 0.3s ease, filter 0.3s ease; filter: drop-shadow(0 0 6px rgba(0,0,0,0.4));
      fill: #4287f5;
    }
    #map-svg g:hover circle {
      r: 18;
      filter: drop-shadow(0 0 12px rgba(0,0,0,0.8)) drop-shadow(0 0 10px currentColor);
      animation: pulse 3s infinite alternate ease-in-out;
    }
    @keyframes pulse { 0% { filter: drop-shadow(0 0 10px currentColor); } 100% { filter: drop-shadow(0 0 30px currentColor); } }
    #map-svg text.region-number {
      font-weight: 700; font-size: 14px; fill: yellow; stroke: black; stroke-width: 1; paint-order: stroke;
      user-select: none; pointer-events: none; text-anchor: middle;
    }
    #map-svg text.region-name {
      font-weight: 600; font-size: 10px; fill: white; stroke: rgba(0,0,0,0.8); stroke-width: 1px; paint-order: stroke;
      user-select: none; pointer-events: none; text-anchor: middle;
    }

    #register-modal {
      position: fixed; bottom: 20px; right: 20px; width: 320px; max-height: 80vh; overflow-y: auto;
      background: #222a44; color: #eee; border-radius: 12px; box-shadow: 0 0 25px rgba(0,0,0,0.8);
      padding: 1.5rem; z-index: 2000;
    }
    #register-modal.active { display: block; }
    #register-modal:not(.active) { display: none; }
    #register-modal h2 { margin-top: 0; margin-bottom: 1rem; text-align: center; text-shadow: 0 0 6px #00aaff; }
    #register-form label { display: block; margin-top: 0.8rem; }
    #register-form input[type="text"] {
      width: 100%; padding: 0.5rem; margin-top: 0.3rem; box-sizing: border-box;
      border-radius: 6px; border: 1px solid #004466; background: #112244; color: #aad4ff; font-weight: 600;
    }
    #register-form button {
      cursor: pointer; background: #00aaff; color: white; border: none; border-radius: 8px; padding: 0.6rem 1.2rem;
      margin: 0.3rem 0; font-weight: 700; transition: background 0.3s ease; box-shadow: 0 0 10px #00aaff; width: 100%;
    }
    #register-form button:hover { background: #008fcc; }
    #register-msg { margin-top: 1rem; font-weight: 700; color: #22cc88; text-align: center; }
    #leaderboard { margin-top: 1rem; max-height: 150px; overflow-y: auto; border: 1px solid #004466; border-radius: 6px;
      padding: 0.5rem; background: #112244dd; color: #aad4ff; }
    #leaderboard h3 { margin: 0 0 0.5rem 0; text-align: center; }
    #leaderboard table { width: 100%; border-collapse: collapse; }
    #leaderboard th, #leaderboard td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #004466; }
    #close-register-btn { background:#c0392b; color:white; border:none; border-radius:6px; padding:0.5rem 1rem; margin-top:1rem; cursor:pointer; width:100%; }
    #close-register-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #open-register-btn {
      position: fixed; bottom: 20px; right: 20px; background: #00aaff; color: white; border: none; border-radius: 6px;
      padding: 0.5rem 1rem; cursor: pointer; z-index: 2000; transition: background 0.3s ease;
    }
    #open-register-btn:hover { background: #008fcc; }

    #admin-status {
      position: fixed; top: 10px; left: 10px; z-index: 2300; padding: 0.3rem 1rem; border-radius: 8px;
      font-weight: 700; color: #eee; background-color: #aa2222; box-shadow: 0 0 12px #aa2222; user-select: none;
    }
    #admin-status.online { background-color: #22aa22; box-shadow: 0 0 12px #22aa22; }
    #admin-login-btn {
      position: fixed; top: 10px; left: 190px; background: #aa2222; color: #fff; border: none; border-radius: 8px;
      padding: 0.3rem 1rem; font-weight: 700; cursor: pointer; z-index: 2300;
    }

    #player-selection {
      position: fixed; top: 80px; left: 10px; background: #222a44; padding: 1rem; border-radius: 10px;
      box-shadow: 0 0 10px #000; z-index: 1500; width: 260px; color: #aad4ff; max-height: 500px;
      display: flex; flex-direction: column;
    }
    #player-selection.hidden { display: none !important; }
    #player-selection label { font-weight: bold; }
    #player-selection ul { list-style: none; padding: 0; margin: 0.5rem 0; overflow-y: auto; max-height: 200px; }
    #player-selection li { list-style: none; }
    #selected-players-details li { list-style: disc; margin-left: 1rem; }
    #toggle-players-btn {
      position: fixed; top: 50px; left: 10px; background: #00aaff; color: #fff; border: none; border-radius: 6px;
      padding: 0.4rem 0.8rem; cursor: pointer; z-index: 2300;
    }
    #reset-selection-btn {
      margin-top: 0.5rem; background: #c0392b; color: white; border: none; border-radius: 6px; padding: 0.4rem;
      cursor: pointer; font-weight: 700; transition: background 0.3s ease;
    }
    #reset-selection-btn:hover { background: #a83232; }

    #menu-toggle-btn {
      position: fixed; top: 10px; right: 10px; background: #00aaff; color: #fff; border: none; border-radius: 6px;
      padding: 0.4rem 0.8rem; cursor: pointer; z-index: 2300;
    }
    #menu-container {
      position: fixed; top: 40px; right: 10px; background: #222a44; border: 1px solid #004466; border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5); display: none; z-index: 2300; padding: 8px;
    }
    #menu-container button {
      display: block; width: 180px; margin: 4px 0; background: #004466; color: white; border: none; border-radius: 6px;
      padding: 0.5rem 1rem; cursor: pointer; font-weight: 700; text-align: left;
    }
    #menu-container button:hover { background: #008fcc; }

    #quiz-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #222a44; color: #eee; border-radius: 12px; box-shadow: 0 0 25px rgba(0,0,0,0.8);
      width: 90vw; max-width: 480px; max-height: 90vh; overflow-y: auto; padding: 1.5rem; display: none; z-index: 2100;
    }
    #quiz-modal.active { display: block; }
    #quiz-modal h2 { margin-top: 0; margin-bottom: 1rem; text-align: center; text-shadow: 0 0 6px #00aaff; }
    #quiz-modal .quiz-region-title {
      font-size: 1.5rem; font-weight: 900; text-align: center; margin-bottom: 0.8rem; animation: blinkFast 1s infinite alternate;
      color: #22cc88; text-shadow: 0 0 8px #22cc88, 0 0 20px #22cc88;
    }
    #quiz-content button.answer-btn {
      width: 100%; text-align: left; background: #0d1c3a; color: #aad4ff; border: 1px solid #004466;
      margin-bottom: 0.3rem; border-radius: 6px; font-weight: 600; transition: background 0.3s ease;
    }
    #quiz-content button.answer-btn.correct { background: #22cc88; color: white; border-color: #22cc88; animation: flashGreen 0.8s; }
    #quiz-content button.answer-btn.wrong { background: #cc4455; color: white; border-color: #cc4455; animation: flashRed 0.8s; }
    @keyframes flashGreen { 0% { background-color: #22cc88; } 100% { background-color: #0d1c3a; } }
    @keyframes flashRed { 0% { background-color: #cc4455; } 100% { background-color: #0d1c3a; } }
    #quiz-controls { margin-top: 1rem; text-align: center; }
    #quiz-feedback { margin-top: 1rem; font-weight: 700; text-align: center; }
    #quiz-controls button {
      cursor: pointer; background: #00aaff; color: white; border: none; border-radius: 8px; padding: 0.6rem 1.2rem;
      margin: 0.3rem; font-weight: 700; transition: background 0.3s ease; box-shadow: 0 0 10px #00aaff; z-index: 2101;
    }
    #quiz-controls button:hover { background: #008fcc; }
    #quiz-image { max-width: 100%; max-height: 180px; border-radius: 12px; box-shadow: 0 0 10px #00aaff; display: none; margin-bottom: 10px; }
    #quiz-timer { margin: 0.5rem 0; font-weight: 700; text-align: center; }

    #manage-questions-modal, #manage-images-modal, #manage-numbers-modal, #manage-pacchi-modal {
      display: none; position: fixed; top: 50%; left: 50%; width: 90vw; max-width: 700px; max-height: 80vh; overflow-y: auto;
      background: #222a44; color: #eee; border-radius: 12px; box-shadow: 0 0 25px rgba(0,0,0,0.8);
      padding: 1rem 1.5rem; transform: translate(-50%, -50%); z-index: 2200;
    }
    #manage-questions-modal h2, #manage-images-modal h2, #manage-numbers-modal h2, #manage-pacchi-modal h2 { margin-top: 0; text-align: center; margin-bottom: 1rem; }
    #manage-questions-modal label, #manage-images-modal label, #manage-numbers-modal label, #manage-pacchi-modal label { display: block; margin-top: 0.5rem; }

    #manage-questions-modal textarea,
    #manage-questions-modal input[type="password"],
    #manage-images-modal textarea,
    #manage-numbers-modal textarea,
    #manage-numbers-modal input[type="password"],
    #manage-pacchi-modal textarea,
    #manage-pacchi-modal input[type="password"],
    #manage-pacchi-modal input[type="text"],
    #manage-pacchi-modal input[type="number"],
    #manage-pacchi-modal select {
      width: 100%; font-family: monospace; font-size: 14px; border-radius: 6px; border: 1px solid #004466;
      background: #112244; color: #aad4ff; padding: 0.5rem; box-sizing: border-box;
    }
    #manage-questions-modal textarea, #manage-numbers-modal textarea { height: 300px; resize: vertical; }
    #manage-questions-modal button, #manage-images-modal button, #manage-numbers-modal button, #manage-pacchi-modal button {
      margin-top: 1rem; padding: 0.5rem 1rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 700;
      box-shadow: 0 0 10px #00aaff; background: #00aaff; color: white;
    }
    #manage-questions-modal button:hover, #manage-images-modal button:hover, #manage-numbers-modal button:hover, #manage-pacchi-modal button:hover { background: #008fcc; }
    #manage-questions-modal #password-msg, #manage-images-modal #images-password-msg, #manage-numbers-modal #numbers-password-msg, #manage-pacchi-modal #pacchi-password-msg {
      margin-top: 0.5rem; font-weight: 700; text-align: center; color: #ff4444;
    }
    #manage-questions-modal #save-msg, #manage-images-modal #images-save-msg, #manage-numbers-modal #numbers-save-msg, #manage-pacchi-modal #pacchi-save-msg {
      margin-top: 0.5rem; font-weight: 700; text-align: center; color: #22cc88;
    }

    #open-custom-pacco-form {
      background:#ffaa00; color:#000; font-weight:700; border:none; border-radius:6px; padding:0.5rem 1rem; margin-top:6px;
      cursor:pointer; box-shadow:0 0 6px #ffaa00; width:100%; text-align:center;
    }
    #open-custom-pacco-form:hover { background:#dd9900; }
    #custom-pacco-form { display:none; margin-top:10px; padding:10px; background:#112244; border:1px solid #004466; border-radius:6px; }
    #custom-pacco-form label { display:block; margin-top:8px; color:#aad4ff; }
    #custom-pacco-form input[type="text"], #custom-pacco-form input[type="number"], #custom-pacco-form select, #custom-pacco-form textarea {
      width:100%; margin-top:4px; padding:4px; background:#112244; color:#aad4ff; border:1px solid #004466; border-radius:4px;
      box-sizing:border-box; font-family:monospace;
    }
    #custom-pacco-form textarea { height:60px; }
    #add-custom-pacco-btn {
      background:#22cc88; color:#000; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; box-shadow:0 0 6px #22cc88;
      margin-top:10px; width:100%; font-weight:700;
    }
    #add-custom-pacco-btn:hover { background:#20bb77; }
    #custom-pacco-msg { margin-top:6px; font-weight:bold; }

    #quiz-flash-container {
      position: fixed; bottom: 20px; left: 20px; z-index: 100; user-select: none; cursor: default;
      display: flex; flex-direction: column; align-items: flex-start; width: max-content;
      transform: scale(1.5); transform-origin: bottom left;
    }
    .quiz-flash {
      animation: quiz-flash 2.5s infinite ease-in-out; font-weight: 900; font-size: 2rem; font-family: 'Arial Black', Arial, sans-serif;
      color: #22cc88; text-shadow: 0 0 8px #22cc88, 0 0 20px #22cc88; margin-bottom: 10px;
    }
    #quiz-flash-image {
      position: fixed; bottom: calc(20px + 2rem * 1.5 + 10px); left: 20px; z-index: 100; max-width: 180px;
      width: auto; height: auto; filter: drop-shadow(0 0 4px #22cc88); user-select: none; cursor: default;
    }
    @keyframes quiz-flash {
      0%, 100% { color: #22cc88; text-shadow: 0 0 8px #22cc88, 0 0 20px #22cc88; }
      25% { color: #ffffff; text-shadow: 0 0 15px #ffffff, 0 0 30px #22cc88; }
      50% { color: #ff4444; text-shadow: 0 0 20px #ff4444, 0 0 40px #ff4444; }
      75% { color: #ffffff; text-shadow: 0 0 15px #ffffff, 0 0 30px #ff4444; }
    }
    @media (max-width: 480px) { #quiz-flash-container { pointer-events: none; opacity: 0.5; } }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal-box {
      background: #222a44; color: #eee; border-radius: 8px; padding: 1rem; max-width: 90vw; width: 320px;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
    }
    .modal-box h3 { margin-top: 0; margin-bottom: 0.5rem; text-align: center; font-size: 1.1rem; }
    .modal-box p { margin: 0.5rem 0; }
    .modal-buttons { display: flex; justify-content: flex-end; margin-top: 1rem; }
    .modal-buttons button {
      margin-left: 0.5rem; padding: 0.4rem 0.8rem; border: none; border-radius: 6px; cursor: pointer;
      background: #00aaff; color: #fff; font-weight: 600; box-shadow: 0 0 8px #00aaff;
    }
    .modal-buttons button.cancel { background: #aa2222; box-shadow: 0 0 8px #aa2222; }
    .modal-input {
      width: 100%; padding: 0.4rem; margin-top: 0.5rem; border: 1px solid #004466; border-radius: 6px;
      background: #112244; color: #aad4ff; box-sizing: border-box;
    }

    #game-mode-in-register {
      margin-bottom: 1rem; background-color: #112244; padding: 0.5rem; border: 1px solid #004466; border-radius: 6px;
      color: #aad4ff; font-size: 0.9rem;
    }
    #game-mode-in-register p { margin: 0 0 4px 0; font-weight: 700; }
    #game-mode-in-register label { display: flex; align-items: center; margin-bottom: 2px; cursor: pointer; font-size: 0.85rem; }
    #game-mode-in-register input[type="radio"] { margin-right: 4px; transform: scale(0.8); }

    /* Orologio real-time */
    #real-time-clock {
      position: fixed; left: 10px; top: 0; background: rgba(0, 0, 0, 0.6); color: #fff; padding: 0.4rem 0.8rem;
      border-radius: 6px; font-family: monospace; font-size: 0.9rem; z-index: 2300; pointer-events: none;
    }
  </style>

  <!-- Firebase (modulo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
      collection, query, orderBy, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    // TODO: incolla qui la tua firebaseConfig reale
    const firebaseConfig = {
      apiKey: "…",
      authDomain: "…",
      projectId: "…",
      storageBucket: "…",
      messagingSenderId: "…",
      appId: "…"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.MP = { db, auth, roomId: null, uid: null, nickname: null, isAdmin: false, unsubRoom: null, unsubPlayers: null };

    async function mpEnsureAuth() {
      if (window.MP.uid) return window.MP.uid;
      const cred = await signInAnonymously(auth);
      window.MP.uid = cred.user.uid;
      return window.MP.uid;
    }

    function mpGenRoomCode(len = 6) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    window.mpHostRoom = async function (nickname, initialState) {
      await mpEnsureAuth();
      const roomCode = mpGenRoomCode(6);
      const roomRef = doc(db, "rooms", roomCode);

      await setDoc(roomRef, {
        adminUid: window.MP.uid,
        adminOnline: true,
        gameMode: initialState.gameMode ?? "quiz",
        quizTimeLimit: initialState.quizTimeLimit ?? 15,
        currentTurnIndex: 0,
        turnOrder: [],
        selectedPlayers: [],
        completedRegions: [],
        createdAt: serverTimestamp()
      });

      const playerRef = doc(db, "rooms", roomCode, "players", window.MP.uid);
      await setDoc(playerRef, { nickname, score: 0, wins: 0, losses: 0, games: 0, joinedAt: serverTimestamp() });

      window.MP.roomId = roomCode;
      window.MP.nickname = nickname;
      window.MP.isAdmin = true;

      mpAttachListeners(roomCode);
      return roomCode;
    };

    window.mpJoinRoom = async function (roomCode, nickname) {
      await mpEnsureAuth();
      const roomRef = doc(db, "rooms", roomCode);
      const snap = await getDoc(roomRef);
      if (!snap.exists()) throw new Error("Room inesistente");

      const playerRef = doc(db, "rooms", roomCode, "players", window.MP.uid);
      await setDoc(playerRef, { nickname, score: 0, wins: 0, losses: 0, games: 0, joinedAt: serverTimestamp() }, { merge: true });

      window.MP.roomId = roomCode;
      window.MP.nickname = nickname;
      window.MP.isAdmin = (snap.data().adminUid === window.MP.uid);

      mpAttachListeners(roomCode);
      return true;
    };

    function mpAttachListeners(roomCode) {
      if (window.MP.unsubRoom) window.MP.unsubRoom();
      if (window.MP.unsubPlayers) window.MP.unsubPlayers();

      const roomRef = doc(db, "rooms", roomCode);
      window.MP.unsubRoom = onSnapshot(roomRef, (s) => {
        if (!s.exists()) return;
        window.dispatchEvent(new CustomEvent("mp-room", { detail: { roomCode, data: s.data() } }));
      });

      const playersRef = collection(db, "rooms", roomCode, "players");
      const qPlayers = query(playersRef, orderBy("score", "desc"));
      window.MP.unsubPlayers = onSnapshot(qPlayers, (qs) => {
        const players = [];
        qs.forEach((d) => players.push({ uid: d.id, ...d.data() }));
        window.dispatchEvent(new CustomEvent("mp-players", { detail: { roomCode, players } }));
      });
    }

    window.mpUpdateRoom = async function (patch) {
      if (!window.MP.roomId) throw new Error("Non sei in una room");
      await updateDoc(doc(db, "rooms", window.MP.roomId), patch);
    };

    window.mpUpdateMyStats = async function (patch) {
      if (!window.MP.roomId) throw new Error("Non sei in una room");
      await updateDoc(doc(db, "rooms", window.MP.roomId, "players", window.MP.uid), patch);
    };

    window.mpIncrementMyScore = async function (delta) {
      await window.mpUpdateMyStats({ score: increment(delta) });
    };

    window.mpInc = increment;
  </script>
</head>

<body>
  <h1>Quiz Interattivo: Regioni d’Italia + Cultura, Arte, Musica, Cucina, Spettacolo</h1>

  <div id="admin-status">Admin Online: OFF</div>
  <button id="admin-login-btn">Login Admin</button>

  <button id="toggle-players-btn">Mostra Giocatori</button>

  <button id="menu-toggle-btn">Menu</button>
  <div id="menu-container">
    <button id="manage-questions-btn" title="Gestisci domande quiz">Gestisci Domande</button>
    <button id="manage-images-btn" title="Gestisci immagini regioni">Gestisci Immagini</button>
    <button id="external-manage-btn" title="Gestione Domande Esterna">Domande Esterna</button>
    <button id="manage-numbers-btn" title="Gestisci Numeri Regioni">Gestisci Numeri</button>
    <button id="manage-pacchi-btn" title="Gestisci Pacchi">Gestisci Pacchi</button>
    <button id="archive-events-btn" title="Archivio Eventi">Archivio Eventi</button>
    <button id="documents-btn" title="Documenti">Documenti</button>
  </div>

  <div id="player-selection">
    <label><strong>Seleziona Giocatori:</strong></label>
    <ul id="player-list"></ul>
    <div id="players-info">
      <p><strong>Giocatori selezionati:</strong></p>
      <div id="selected-players-details">Nessun giocatore selezionato.</div>
    </div>
    <button id="reset-selection-btn">Reset Selezioni</button>
  </div>

  <div id="register-modal" role="dialog" aria-modal="true" aria-labelledby="register-title" class="active">
    <h2 id="register-title">Registrazione e Classifica Partecipanti</h2>

    <div id="game-mode-in-register">
      <p>Modalità di gioco:</p>
      <label><input type="radio" name="game-mode" value="quiz"> Quiz</label>
      <label><input type="radio" name="game-mode" value="pacchi"> Pacchi e Numeri</label>
    </div>

    <!-- Configurazione timer quiz -->
    <div id="quiz-time-config" style="margin-top:1rem; color:#aad4ff;">
      <label for="quiz-time-input" style="font-weight:700;">Durata timer quiz (secondi):</label>
      <input type="number" id="quiz-time-input" min="5" max="300" step="5" value="15"
             style="width:70px; margin-left:0.5rem;" />
      <button id="save-quiz-time-btn" type="button"
              style="margin-left:0.5rem; background:#00aaff; color:#fff; padding:0.4rem 0.8rem; border:none; border-radius:6px; cursor:pointer;">
        Salva
      </button>
      <div id="quiz-time-msg" aria-live="polite" style="margin-top:0.5rem; font-size:0.9rem;"></div>
    </div>

    <div id="room-box" style="margin:0.8rem 0; padding:0.6rem; border:1px solid #004466; border-radius:8px; background:#112244;">
      <div style="font-weight:800; margin-bottom:6px;">Multiplayer (Firebase)</div>

      <label style="display:block; margin-top:6px;">
        Room code:
        <input id="room-code-input" type="text" maxlength="12" placeholder="es: ABC123" class="modal-input" style="margin-top:4px;">
      </label>

      <button id="host-room-btn" type="button" style="margin-top:8px; width:100%;">Crea Stanza (HOST)</button>
      <button id="join-room-btn" type="button" style="margin-top:6px; width:100%;">Entra in Stanza (JOIN)</button>

      <div id="room-status" style="margin-top:8px; font-weight:700; color:#aad4ff;"></div>
    </div>

    <form id="register-form">
      <label for="nickname">Inserisci il tuo Nickname:</label>
      <input type="text" id="nickname" name="nickname" required minlength="3" maxlength="20" placeholder="Nickname" autocomplete="off" />
      <button type="submit">Registrati</button>
    </form>

    <div id="register-msg" aria-live="polite"></div>

    <div id="leaderboard">
      <h3>Classifica Partecipanti</h3>
      <table>
        <thead>
          <tr><th>#</th><th>Nickname</th><th>Vittorie</th><th>Sconfitte</th><th>Partite</th><th>Punteggio</th></tr>
        </thead>
        <tbody id="leaderboard-body"></tbody>
      </table>
    </div>

    <button id="close-register-btn" type="button">Chiudi Registrazione</button>
  </div>

  <button id="open-register-btn" type="button">Apri Registrazione</button>

  <div id="map-container">
    <img src="https://i.postimg.cc/dtmzm3F8/Senza-titolo-4000-x-6000-px.png" alt="Mappa Italia" />
    <svg id="map-svg" viewBox="0 0 500 700" preserveAspectRatio="xMidYMid meet">
      <g id="IT-25" data-region-code="IT-25" data-region-name="Piemonte" transform="translate(64.44,188.88)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Piemonte</text>
      </g>
      <g id="IT-23" data-region-code="IT-23" data-region-name="Valle d'Aosta" transform="translate(51.11,142.77)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Valle d'Aosta</text>
      </g>
      <g id="IT-42" data-region-code="IT-42" data-region-name="Liguria" transform="translate(96.66,225)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Liguria</text>
      </g>
      <g id="IT-21" data-region-code="IT-21" data-region-name="Lombardia" transform="translate(136.66,155.55)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Lombardia</text>
      </g>
      <g id="IT-32" data-region-code="IT-32" data-region-name="Trentino-Alto Adige" transform="translate(190.55,98.33)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Trentino-Alto Adige</text>
      </g>
      <g id="IT-34" data-region-code="IT-34" data-region-name="Veneto" transform="translate(209.44,168.88)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Veneto</text>
      </g>
      <g id="IT-45" data-region-code="IT-45" data-region-name="Friuli-Venezia Giulia" transform="translate(261.66,126.66)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Friuli-Venezia Giulia</text>
      </g>
      <g id="IT-36" data-region-code="IT-36" data-region-name="Emilia-Romagna" transform="translate(192.77,217.22)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Emilia-Romagna</text>
      </g>
      <g id="IT-52" data-region-code="IT-52" data-region-name="Toscana" transform="translate(187.77,260.55)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Toscana</text>
      </g>
      <g id="IT-55" data-region-code="IT-55" data-region-name="Umbria" transform="translate(245.54,298.88)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Umbria</text>
      </g>
      <g id="IT-57" data-region-code="IT-57" data-region-name="Marche" transform="translate(267.77,280)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Marche</text>
      </g>
      <g id="IT-62" data-region-code="IT-62" data-region-name="Lazio" transform="translate(240.55,333.33)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Lazio</text>
      </g>
      <g id="IT-67" data-region-code="IT-67" data-region-name="Abruzzo" transform="translate(292.21,329.44)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Abruzzo</text>
      </g>
      <g id="IT-65" data-region-code="IT-65" data-region-name="Molise" transform="translate(300,360)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Molise</text>
      </g>
      <g id="IT-72" data-region-code="IT-72" data-region-name="Campania" transform="translate(328.88,400)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Campania</text>
      </g>
      <g id="IT-75" data-region-code="IT-75" data-region-name="Puglia" transform="translate(403.33,388.33)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Puglia</text>
      </g>
      <g id="IT-77" data-region-code="IT-77" data-region-name="Basilicata" transform="translate(383.88,422.22)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Basilicata</text>
      </g>
      <g id="IT-78" data-region-code="IT-78" data-region-name="Calabria" transform="translate(398.88,483.33)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Calabria</text>
      </g>
      <g id="IT-88" data-region-code="IT-88" data-region-name="Sicilia" transform="translate(306.11,567.77)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Sicilia</text>
      </g>
      <g id="IT-82" data-region-code="IT-82" data-region-name="Sardegna" transform="translate(99.44,431.11)">
        <circle cx="0" cy="0" r="12"/><text class="region-number" x="0" y="-12"></text><text class="region-name" x="0" y="16">Sardegna</text>
      </g>
    </svg>
  </div>

  <div id="quiz-modal" role="dialog" aria-modal="true" aria-labelledby="quiz-title">
    <h2 id="quiz-title">Quiz Regione</h2>
    <div id="quiz-timer"></div>
    <img id="quiz-image" src="" alt="" />
    <div id="quiz-content"></div>
    <div id="quiz-feedback"></div>
    <div id="quiz-controls">
      <button id="prev-btn" disabled type="button">Precedente</button>
      <button id="next-btn" type="button">Successiva</button>
      <button id="close-quiz-btn" type="button" style="background:#c0392b;">Chiudi</button>
    </div>
  </div>

  <!-- MODALI ADMIN (identici ai tuoi) -->
  <div id="manage-questions-modal" role="dialog" aria-modal="true" aria-labelledby="manage-questions-title">
    <h2 id="manage-questions-title">Gestione Domande (Password richiesta)</h2>
    <div id="password-section">
      <form id="manage-questions-password-form" onsubmit="return false;">
        <label for="manage-questions-username" class="visually-hidden">Username Admin</label>
        <input type="text" id="manage-questions-username" name="username" class="visually-hidden" autocomplete="username" value="admin" />
        <label for="admin-password">Inserisci password:</label>
        <input type="password" id="admin-password" name="password" autocomplete="current-password" required class="modal-input" />
        <button id="check-password-btn" type="submit">Entra</button>
      </form>
      <div id="password-msg" aria-live="polite"></div>
    </div>
    <div id="questions-editor-section" style="display:none;">
      <label for="questions-json">JSON Domande (modifica con attenzione):</label>
      <textarea id="questions-json" style="width:100%; height:200px; font-family: monospace;"></textarea>
      <button id="generate-auto-questions-btn" type="button" style="margin-top:1rem; background:#00cc88; color:#000; border:none; border-radius:6px; padding:0.5rem 1rem; cursor:pointer; font-weight:700;">
        Genera domande automatiche da dati statici/estesi
      </button>
      <button id="save-questions-btn" type="button">Salva Domande</button>
      <button id="reset-data-btn" type="button" style="background:#aa2222; margin-top: 10px;">Reset Tutti Dati (Admin)</button>
      <button id="close-manage-btn" type="button" style="background:#c0392b; margin-top: 10px;">Chiudi</button>
      <div id="save-msg" aria-live="polite"></div>
    </div>
  </div>

  <div id="manage-images-modal" role="dialog" aria-modal="true" aria-labelledby="manage-images-title">
    <h2 id="manage-images-title">Gestione Immagini Regioni (Password richiesta)</h2>
    <div id="images-password-section">
      <form id="manage-images-password-form" onsubmit="return false;">
        <label for="manage-images-username" class="visually-hidden">Username Admin</label>
        <input type="text" id="manage-images-username" name="username" class="visually-hidden" autocomplete="username" value="admin" />
        <label for="images-admin-password">Inserisci password:</label>
        <input type="password" id="images-admin-password" name="password" autocomplete="current-password" required class="modal-input" />
        <button id="check-images-password-btn" type="submit">Entra</button>
      </form>
      <div id="images-password-msg" aria-live="polite"></div>
    </div>
    <div id="images-editor-section" style="display:none;">
      <div id="images-list-container"></div>
      <button id="save-images-btn" type="button">Salva Immagini</button>
      <button id="close-images-manage-btn" type="button" style="background:#c0392b; margin-top: 10px;">Chiudi</button>
      <div id="images-save-msg" aria-live="polite"></div>
    </div>
  </div>

  <div id="manage-numbers-modal" role="dialog" aria-modal="true" aria-labelledby="manage-numbers-title">
    <h2 id="manage-numbers-title">Gestione Numeri Regioni (Password richiesta)</h2>
    <div id="numbers-password-section">
      <form id="manage-numbers-password-form" onsubmit="return false;">
        <label for="manage-numbers-username" class="visually-hidden">Username Admin</label>
        <input type="text" id="manage-numbers-username" name="username" class="visually-hidden" autocomplete="username" value="admin" />
        <label for="numbers-admin-password">Inserisci password:</label>
        <input type="password" id="numbers-admin-password" name="password" autocomplete="current-password" required class="modal-input" />
        <button id="check-numbers-password-btn" type="submit">Entra</button>
      </form>
      <div id="numbers-password-msg" aria-live="polite"></div>
    </div>
    <div id="numbers-editor-section" style="display:none;">
      <label for="numbers-json">JSON Numeri (modifica con attenzione):</label>
      <textarea id="numbers-json" style="width:100%; height:200px; font-family: monospace;"></textarea>
      <div id="numbers-helper" style="margin-top:0.5rem; max-height:150px; overflow-y:auto; background:#112244; padding:0.5rem; border:1px solid #004466; border-radius:6px;"></div>
      <button id="save-numbers-btn" type="button">Salva Numeri</button>
      <button id="close-numbers-manage-btn" type="button" style="background:#c0392b; margin-top: 10px;">Chiudi</button>
      <div id="numbers-save-msg" aria-live="polite"></div>
    </div>
  </div>

  <div id="manage-pacchi-modal" role="dialog" aria-modal="true" aria-labelledby="manage-pacchi-title">
    <h2 id="manage-pacchi-title">Gestione Pacchi (Password richiesta)</h2>
    <div id="pacchi-password-section">
      <form id="manage-pacchi-password-form" onsubmit="return false;">
        <label for="manage-pacchi-username" class="visually-hidden">Username Admin</label>
        <input type="text" id="manage-pacchi-username" name="username" class="visually-hidden" autocomplete="username" value="admin" />
        <label for="pacchi-admin-password">Inserisci password:</label>
        <input type="password" id="pacchi-admin-password" name="password" autocomplete="current-password" required class="modal-input" />
        <button id="check-pacchi-password-btn" type="submit">Entra</button>
      </form>
      <div id="pacchi-password-msg" aria-live="polite"></div>
    </div>
    <div id="pacchi-editor-section" style="display:none;">
      <div id="pacchi-list-container"></div>
      <label for="pacchi-import-text">Importa codici pacco (es. IT-25={"pack":"Testo...","effect":{"type":"score","delta":2},"imageUrl":"https://..."} )</label>
      <textarea id="pacchi-import-text" placeholder='IT-25={"pack":"Testo...","effect":{"type":"score","delta":2},"imageUrl":"https://example.com/immagine.jpg"}' style="width:100%; height:100px; font-family: monospace;"></textarea>
      <button id="import-pacchi-btn" type="button">Importa codici</button>
      <div id="pacchi-import-msg" aria-live="polite"></div>

      <button id="generate-offline-pacchi-btn" type="button" style="margin-top:1rem; background:#00cc88; color:#000; border:none; border-radius:6px; padding:0.5rem 1rem; cursor:pointer; font-weight:700;">
        Genera pacchi offline
      </button>
      <button id="generate-online-pacchi-btn" type="button" style="margin-top:0.5rem; background:#0066cc; color:#fff; border:none; border-radius:6px; padding:0.5rem 1rem; cursor:pointer; font-weight:700;">
        Genera pacchi avanzati (Wikipedia)
      </button>

      <button id="save-pacchi-btn" type="button">Salva Pacchi</button>
      <button id="open-custom-pacco-form" type="button">Crea Pacco Personalizzato</button>

      <div id="custom-pacco-form">
        <label>Regione: <select id="custom-region-select"></select></label>
        <label>Descrizione Pacco: <input type="text" id="custom-pack-text" placeholder="Es. Ricevi 20 rays"></label>
        <label>Tipo Effetto:
          <select id="custom-effect-type">
            <option value="score">score (delta punti)</option>
            <option value="skipTurn">skipTurn</option>
            <option value="extraTurn">extraTurn</option>
            <option value="custom">custom JSON</option>
          </select>
        </label>
        <div id="custom-effect-params">
          <label id="label-delta" style="display:none;">Delta: <input type="number" id="custom-delta" placeholder="Es. 20"></label>
          <label id="label-currency" style="display:none; margin-top:6px;">Currency (opzionale): <input type="text" id="custom-currency" placeholder="Es. rays o EUR"></label>
          <label id="label-custom-json" style="display:none; margin-top:6px;">JSON Effetto:
            <textarea id="custom-json-text" placeholder='Es. {"type":"bonus","value":...}'></textarea>
          </label>
        </div>
        <button id="add-custom-pacco-btn" type="button">Aggiungi Pacco</button>
        <div id="custom-pacco-msg" aria-live="polite"></div>
      </div>

      <button id="close-pacchi-manage-btn" type="button" style="background:#c0392b; margin-top: 10px;">Chiudi</button>
      <div id="pacchi-save-msg" aria-live="polite"></div>
    </div>
  </div>

  <div id="generic-modal-container" style="display:none;"></div>

  <div id="quiz-flash-container">
    <div class="quiz-flash">Pronto per il Quiz?</div>
    <img id="quiz-flash-image" src="https://i.postimg.cc/qRr67dMT/63baeef3-5306-4d77-9e38-1195f592ecab-trasparente.png" alt="Decorazione Quiz" />
  </div>

  <div id="real-time-clock" aria-label="Orologio in tempo reale"></div>

  <script>
    // ================= CONFIG =================
    const QUIZ_DATA_URL = '';
    const PACCHI_DATA_URL = '';
    const QUIZ_DATA_SAVE_URL = '';
    const PACCHI_DATA_SAVE_URL = '';
    const ADMIN_PASSWORD = "Morena7";
    const EXTERNAL_PASSWORD = "Morena7";

    // ================= MULTIPLAYER GLOBAL =================
    // (globali veri, non dentro un callback)
    let multiplayerEnabled = false;
    let roomState = null;

    // ================= STATE =================
    let adminOnline = false;
    let quizTimeLimit = 15;
    let quizTimeRemaining = 0;
    let quizIntervalId = null;

    function saveToLocal(key, obj) {
      try { localStorage.setItem(key, JSON.stringify(obj)); }
      catch (e) { console.error(`Errore salvataggio ${key}`, e); }
    }
    function loadFromLocal(key, defaultValue) {
      const stored = localStorage.getItem(key);
      if (!stored) return defaultValue;
      try { return JSON.parse(stored); }
      catch (e) { console.warn(`Errore parse JSON per ${key}`, e); return defaultValue; }
    }

    // ===== TIMER QUIZ (UNICO, PULITO) =====
    const storedQuizTime = loadFromLocal('quizTimeLimit', null);
    if (storedQuizTime !== null && !isNaN(storedQuizTime)) {
      quizTimeLimit = Number(storedQuizTime);
    }

    // ================= DEFAULT DATA =================
    const defaultQuizData = {
      "IT-25": { region: "Piemonte", questions: [] },
      "IT-23": { region: "Valle d'Aosta", questions: [] },
      "IT-42": { region: "Liguria", questions: [] },
      "IT-21": { region: "Lombardia", questions: [] },
      "IT-32": { region: "Trentino-Alto Adige", questions: [] },
      "IT-34": { region: "Veneto", questions: [] },
      "IT-45": { region: "Friuli-Venezia Giulia", questions: [] },
      "IT-36": { region: "Emilia-Romagna", questions: [] },
      "IT-52": { region: "Toscana", questions: [] },
      "IT-55": { region: "Umbria", questions: [] },
      "IT-57": { region: "Marche", questions: [] },
      "IT-62": { region: "Lazio", questions: [] },
      "IT-67": { region: "Abruzzo", questions: [] },
      "IT-65": { region: "Molise", questions: [] },
      "IT-72": { region: "Campania", questions: [] },
      "IT-75": { region: "Puglia", questions: [] },
      "IT-77": { region: "Basilicata", questions: [] },
      "IT-78": { region: "Calabria", questions: [] },
      "IT-88": { region: "Sicilia", questions: [] },
      "IT-82": { region: "Sardegna", questions: [] }
    };

    const defaultImagesData = {};
    Object.keys(defaultQuizData).forEach(id => defaultImagesData[id] = "");

    const defaultRegionNumbers = {
      "IT-25": 2, "IT-23": 19, "IT-42": 8, "IT-21": 9, "IT-32": 17, "IT-34": 20,
      "IT-45": 6, "IT-36": 5, "IT-52": 16, "IT-55": 18, "IT-57": 10, "IT-62": 7,
      "IT-67": 11, "IT-65": 1, "IT-72": 4, "IT-75": 13, "IT-77": 12, "IT-78": 3,
      "IT-88": 15, "IT-82": 14
    };

    const defaultPacchiData = {};
    Object.keys(defaultQuizData).forEach(id => {
      defaultPacchiData[id] = { region: defaultQuizData[id].region, pack: "", effect: { type: "none" } };
    });

    let participants = [];
    let quizData = null;
    let imagesData = null;
    let regionNumbers = null;
    let pacchiData = null;

    let currentPlayer = null;
    let currentRegionCode = null;
    let currentRegionName = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let gameMode = 'quiz';
    let selectedPlayers = new Set();
    let currentTurnIndex = 0;
    let turnOrder = [];
    let completedRegions = [];

    // ================= DOM =================
    const registerModal = document.getElementById('register-modal');
    const registerForm = document.getElementById('register-form');
    const registerMsg = document.getElementById('register-msg');
    const closeRegisterBtn = document.getElementById('close-register-btn');
    const openRegisterBtn = document.getElementById('open-register-btn');

    const quizModal = document.getElementById('quiz-modal');
    const quizContent = document.getElementById('quiz-content');
    const quizFeedback = document.getElementById('quiz-feedback');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const closeQuizBtn = document.getElementById('close-quiz-btn');
    const quizImage = document.getElementById('quiz-image');
    const quizTimerElem = document.getElementById('quiz-timer');
    const svg = document.getElementById("map-svg");

    const adminStatus = document.getElementById('admin-status');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const togglePlayersBtn = document.getElementById('toggle-players-btn');
    const playerSelectionDiv = document.getElementById('player-selection');
    const playerList = document.getElementById('player-list');
    const resetSelectionBtn = document.getElementById('reset-selection-btn');

    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const menuContainer = document.getElementById('menu-container');
    const manageQuestionsBtn = document.getElementById('manage-questions-btn');
    const manageImagesBtn = document.getElementById('manage-images-btn');
    const externalManageBtn = document.getElementById('external-manage-btn');
    const manageNumbersBtn = document.getElementById('manage-numbers-btn');
    const managePacchiBtn = document.getElementById('manage-pacchi-btn');
    const archiveEventsBtn = document.getElementById('archive-events-btn');
    const documentsBtn = document.getElementById('documents-btn');

    const manageQuestionsModal = document.getElementById('manage-questions-modal');
    const passwordSection = document.getElementById('password-section');
    const questionsEditorSection = document.getElementById('questions-editor-section');
    const questionsTextarea = document.getElementById('questions-json');
    const saveQuestionsBtn = document.getElementById('save-questions-btn');
    const generateAutoQuestionsBtn = document.getElementById('generate-auto-questions-btn');
    const closeManageBtn = document.getElementById('close-manage-btn');
    const resetDataBtn = document.getElementById('reset-data-btn');
    const saveMsg = document.getElementById('save-msg');
    const manageQuestionsPasswordForm = document.getElementById('manage-questions-password-form');
    const passwordMsgElem = document.getElementById('password-msg');

    const manageImagesModalElem = document.getElementById('manage-images-modal');
    const imagesPasswordSection = document.getElementById('images-password-section');
    const imagesEditorSection = document.getElementById('images-editor-section');
    const imagesListContainer = document.getElementById('images-list-container');
    const saveImagesBtn = document.getElementById('save-images-btn');
    const closeImagesManageBtn = document.getElementById('close-images-manage-btn');
    const imagesSaveMsg = document.getElementById('images-save-msg');
    const manageImagesPasswordForm = document.getElementById('manage-images-password-form');
    const imagesPasswordMsgElem = document.getElementById('images-password-msg');

    const manageNumbersModalElem = document.getElementById('manage-numbers-modal');
    const numbersPasswordSection = document.getElementById('numbers-password-section');
    const numbersEditorSection = document.getElementById('numbers-editor-section');
    const numbersTextarea = document.getElementById('numbers-json');
    const closeNumbersManageBtn = document.getElementById('close-numbers-manage-btn');
    const numbersSaveMsg = document.getElementById('numbers-save-msg');
    const numbersHelperDiv = document.getElementById('numbers-helper');
    const manageNumbersPasswordForm = document.getElementById('manage-numbers-password-form');
    const numbersPasswordMsgElem = document.getElementById('numbers-password-msg');

    const managePacchiModalElem = document.getElementById('manage-pacchi-modal');
    const pacchiPasswordSectionElem = document.getElementById('pacchi-password-section');
    const pacchiEditorSection = document.getElementById('pacchi-editor-section');
    const pacchiImportText = document.getElementById('pacchi-import-text');
    const importPacchiBtn = document.getElementById('import-pacchi-btn');
    const pacchiImportMsg = document.getElementById('pacchi-import-msg');
    const savePacchiBtnElem = document.getElementById('save-pacchi-btn');
    const openCustomPaccoFormBtn = document.getElementById('open-custom-pacco-form');
    const customPaccoFormDiv = document.getElementById('custom-pacco-form');
    const customRegionSelect = document.getElementById('custom-region-select');
    const customPackTextInput = document.getElementById('custom-pack-text');
    const customEffectTypeSelect = document.getElementById('custom-effect-type');
    const labelDelta = document.getElementById('label-delta');
    const customDeltaInput = document.getElementById('custom-delta');
    const labelCurrency = document.getElementById('label-currency');
    const customCurrencyInput = document.getElementById('custom-currency');
    const labelCustomJson = document.getElementById('label-custom-json');
    const customJsonTextArea = document.getElementById('custom-json-text');
    const addCustomPaccoBtn = document.getElementById('add-custom-pacco-btn');
    const customPaccoMsgDiv = document.getElementById('custom-pacco-msg');
    const closePacchiManageBtn = document.getElementById('close-pacchi-manage-btn');
    const pacchiSaveMsgElem = document.getElementById('pacchi-save-msg');
    const managePacchiPasswordForm = document.getElementById('manage-pacchi-password-form');
    const pacchiPasswordMsgElem = document.getElementById('pacchi-password-msg');

    const gameModeRadios = document.querySelectorAll('input[name="game-mode"]');

    // ================= PERSISTENCE =================
    function saveParticipants() { saveToLocal('participants', participants); }
    function saveQuizDataLocal(data) { saveToLocal('quizData', data); }
    function savePacchiDataLocal(data) { saveToLocal('pacchiData', data); }
    function saveImagesDataLocal(data) { saveToLocal('imagesData', data); }
    function saveRegionNumbersLocal(data) { saveToLocal('regionNumbers', data); }
    function saveSelectedPlayersLocal() { saveToLocal('selectedPlayers', Array.from(selectedPlayers)); }
    function loadSelectedPlayersLocal() {
      const arr = loadFromLocal('selectedPlayers', []);
      selectedPlayers = new Set(Array.isArray(arr) ? arr : []);
    }
    function saveGameModeLocal() { saveToLocal('gameMode', gameMode); }
    function loadGameModeLocal() {
      const gm = loadFromLocal('gameMode', null);
      if (gm === 'quiz' || gm === 'pacchi') gameMode = gm;
    }
    function saveCompletedRegionsLocal() { saveToLocal('completedRegions', completedRegions); }
    function loadCompletedRegionsLocal() {
      const arr = loadFromLocal('completedRegions', []);
      completedRegions = Array.isArray(arr) ? arr : [];
    }

    function loadLocalData() {
      participants = loadFromLocal('participants', []);
      participants.forEach(p => {
        if (typeof p.score !== 'number') p.score = 0;
        if (typeof p.wins !== 'number') p.wins = 0;
        if (typeof p.losses !== 'number') p.losses = 0;
        if (typeof p.games !== 'number') p.games = 0;
      });

      quizData = loadFromLocal('quizData', null) || defaultQuizData;
      saveQuizDataLocal(quizData);

      imagesData = loadFromLocal('imagesData', null) || defaultImagesData;
      saveImagesDataLocal(imagesData);

      regionNumbers = loadFromLocal('regionNumbers', null) || Object.assign({}, defaultRegionNumbers);
      saveRegionNumbersLocal(regionNumbers);

      pacchiData = loadFromLocal('pacchiData', null) || defaultPacchiData;
      savePacchiDataLocal(pacchiData);

      loadGameModeLocal();
      loadSelectedPlayersLocal();
      loadCompletedRegionsLocal();
    }

    function loadRemoteData() {
      const promises = [];
      if (QUIZ_DATA_URL) {
        promises.push(
          fetch(QUIZ_DATA_URL).then(r => { if (!r.ok) throw new Error("Fetch quizData non OK"); return r.json(); })
            .then(remoteQuiz => { quizData = remoteQuiz; saveQuizDataLocal(remoteQuiz); })
            .catch(err => console.warn("Impossibile caricare quizData remoto, uso locale/default", err))
        );
      }
      if (PACCHI_DATA_URL) {
        promises.push(
          fetch(PACCHI_DATA_URL).then(r => { if (!r.ok) throw new Error("Fetch pacchiData non OK"); return r.json(); })
            .then(remotePacchi => { pacchiData = remotePacchi; savePacchiDataLocal(remotePacchi); })
            .catch(err => console.warn("Impossibile caricare pacchiData remoto, uso locale/default", err))
        );
      }
      return Promise.all(promises);
    }

    function saveRemoteData(endpointUrl, data) {
      if (!endpointUrl) return Promise.resolve();
      return fetch(endpointUrl, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(resp => {
        if (!resp.ok) throw new Error("Salvataggio remoto non OK");
        return resp.json();
      });
    }

    // ================= HELPERS =================
    function getRegionName(regionCode) { return quizData[regionCode]?.region || ""; }
    function getRegionNumber(regionCode) {
      const num = regionNumbers[regionCode];
      return (typeof num !== 'undefined') ? num : "";
    }
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function updateLeaderboard() {
      const tbody = document.getElementById('leaderboard-body');
      if (!tbody) return;
      tbody.innerHTML = '';
      participants.forEach(p => {
        if (typeof p.wins!=='number') p.wins=0;
        if (typeof p.losses!=='number') p.losses=0;
        if (typeof p.games!=='number') p.games=0;
        if (typeof p.score!=='number') p.score=0;
      });
      participants.sort((a,b) => (b.score !== a.score) ? (b.score - a.score) : (b.wins - a.wins));
      participants.forEach((p,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${p.nickname}</td><td>${p.wins}</td><td>${p.losses}</td><td>${p.games}</td><td>${p.score}</td>`;
        tbody.appendChild(tr);
      });
    }

    function saveParticipantsAndMaybeRemote() { saveParticipants(); }

    function updateSelectedPlayersInfo() {
      const selected = Array.from(selectedPlayers);
      const container = document.getElementById('selected-players-details');
      if (!container) return;
      if (selected.length === 0) container.textContent = 'Nessun giocatore selezionato.';
      else container.innerHTML = '<ul>' + selected.map(name => `<li>${name}</li>`).join('') + '</ul>';
    }

    function updateTurnIndicator() {
      const indicator = document.getElementById('turn-indicator');
      const nameSpan = document.getElementById('turn-player-name');
      if (!turnOrder || turnOrder.length === 0) {
        if (indicator) indicator.style.display = 'none';
        if (nameSpan) nameSpan.textContent = '';
        return;
      }
      const currentName = turnOrder[currentTurnIndex];
      if (nameSpan) nameSpan.textContent = currentName;
      if (indicator) indicator.style.display = 'block';
    }

    function updateTurnOrder() {
      turnOrder = Array.from(selectedPlayers);
      currentTurnIndex = 0;
      updateTurnIndicator();

      // Multiplayer: solo ADMIN aggiorna
      if (multiplayerEnabled && window.MP?.isAdmin) {
        window.mpUpdateRoom({ turnOrder, currentTurnIndex, selectedPlayers: Array.from(selectedPlayers) }).catch(console.warn);
      }
    }

    function nextPlayerTurn() {
      if (!turnOrder || turnOrder.length === 0) return;
      currentTurnIndex = (currentTurnIndex + 1) % turnOrder.length;
      updateTurnIndicator();
      if (multiplayerEnabled && window.MP?.isAdmin) {
        window.mpUpdateRoom({ currentTurnIndex }).catch(console.warn);
      }
    }

    // ================= UI MODALS =================
    function showAlert(message) {
      return new Promise(resolve => {
        const overlay = document.createElement('div'); overlay.className = 'modal-overlay';
        const box = document.createElement('div'); box.className = 'modal-box';
        box.innerHTML = `<h3>Attenzione</h3><p>${String(message).replace(/\n/g,'<br>')}</p>`;
        const btnContainer = document.createElement('div'); btnContainer.className = 'modal-buttons';
        const okBtn = document.createElement('button'); okBtn.textContent = 'OK';
        okBtn.addEventListener('click', () => { document.body.removeChild(overlay); resolve(); });
        btnContainer.appendChild(okBtn); box.appendChild(btnContainer); overlay.appendChild(box); document.body.appendChild(overlay);
        setTimeout(() => { okBtn.focus(); }, 0);
      });
    }

    function showConfirm(message) {
      return new Promise(resolve => {
        const overlay = document.createElement('div'); overlay.className = 'modal-overlay';
        const box = document.createElement('div'); box.className = 'modal-box';
        box.innerHTML = `<h3>Conferma</h3><p>${message}</p>`;
        const btnContainer = document.createElement('div'); btnContainer.className = 'modal-buttons';
        const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Annulla'; cancelBtn.type='button'; cancelBtn.className='cancel';
        const okBtn = document.createElement('button'); okBtn.textContent = 'OK'; okBtn.type='button';
        cancelBtn.addEventListener('click', () => { document.body.removeChild(overlay); resolve(false); });
        okBtn.addEventListener('click', () => { document.body.removeChild(overlay); resolve(true); });
        btnContainer.appendChild(cancelBtn); btnContainer.appendChild(okBtn); box.appendChild(btnContainer); overlay.appendChild(box); document.body.appendChild(overlay);
        setTimeout(() => { cancelBtn.focus(); }, 0);
      });
    }

    function showPrompt(message) {
      return new Promise(resolve => {
        const overlay = document.createElement('div'); overlay.className = 'modal-overlay';
        const box = document.createElement('div'); box.className = 'modal-box';
        box.innerHTML = `<h3>Inserisci Valore</h3><p>${message}</p>`;
        const form = document.createElement('form');

        const hiddenUser = document.createElement('input');
        hiddenUser.type = 'text'; hiddenUser.name = 'username'; hiddenUser.value = 'admin';
        hiddenUser.autocomplete = 'username'; hiddenUser.className = 'visually-hidden';
        form.appendChild(hiddenUser);

        const input = document.createElement('input');
        input.className='modal-input'; input.type='password'; input.name='password'; input.autocomplete='current-password';
        form.appendChild(input);

        const btnContainer = document.createElement('div'); btnContainer.className = 'modal-buttons';
        const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Annulla'; cancelBtn.type='button'; cancelBtn.className='cancel';
        const okBtn = document.createElement('button'); okBtn.textContent = 'OK'; okBtn.type='submit';
        btnContainer.appendChild(cancelBtn); btnContainer.appendChild(okBtn);
        form.appendChild(btnContainer); box.appendChild(form); overlay.appendChild(box); document.body.appendChild(overlay);

        cancelBtn.addEventListener('click', () => { document.body.removeChild(overlay); resolve(null); });
        form.addEventListener('submit', e => { e.preventDefault(); const val = input.value; document.body.removeChild(overlay); resolve(val); });
        setTimeout(() => { input.focus(); }, 0);
      });
    }

    // ================= ADMIN ONLINE (NO LOOP) =================
    function setAdminOnline(isOnline, syncToRoom = true) {
      adminOnline = isOnline;

      if (syncToRoom && multiplayerEnabled && window.MP?.isAdmin) {
        // evita loop: aggiorna solo se cambia davvero rispetto allo stato room
        const prev = roomState?.adminOnline;
        if (prev !== adminOnline) {
          window.mpUpdateRoom({ adminOnline }).catch(console.warn);
        }
      }

      if (isOnline) {
        adminStatus.textContent="Admin Online: ON";
        adminStatus.classList.add('online');
      } else {
        adminStatus.textContent="Admin Online: OFF";
        adminStatus.classList.remove('online');
      }
      updateAdminLoginBtn();
      positionClock();
    }

    function updateAdminLoginBtn() {
      if (adminOnline) {
        adminLoginBtn.textContent = 'Logout Admin';
        adminLoginBtn.style.background = '#22aa22';
      } else {
        adminLoginBtn.textContent = 'Login Admin';
        adminLoginBtn.style.background = '#aa2222';
      }
      positionClock();
    }

    // ================= MAP VISUAL =================
    function updateRegionNumbers(data) {
      Object.entries(data).forEach(([regionCode, num]) => {
        const group = svg.querySelector(`g[data-region-code="${regionCode}"]`);
        if (!group) return;

        let numberText = group.querySelector('text.region-number');
        if (!numberText) {
          numberText = document.createElementNS("http://www.w3.org/2000/svg","text");
          numberText.classList.add('region-number');
          numberText.setAttribute('text-anchor', 'middle');
          numberText.setAttribute('x', 0);
          numberText.setAttribute('y', -12);
          group.appendChild(numberText);
        }
        numberText.textContent = (typeof num !== 'undefined') ? num : '';

        let nameText = group.querySelector('text.region-name');
        if (!nameText) {
          nameText = document.createElementNS("http://www.w3.org/2000/svg","text");
          nameText.classList.add('region-name');
          nameText.setAttribute('text-anchor', 'middle');
          nameText.setAttribute('x', 0);
          nameText.setAttribute('y', 16);
          group.appendChild(nameText);
        }
        nameText.textContent = getRegionName(regionCode);
      });
    }

    function updateMapProgressVisual() {
      const allRegionCodes = Object.keys(quizData);
      const total = allRegionCodes.length;

      allRegionCodes.forEach(regionCode => {
        const group = svg.querySelector(`g[data-region-code="${regionCode}"]`);
        if (!group) return;
        const existingMarker = group.querySelector('text.completed-marker');

        if (completedRegions.includes(regionCode)) {
          if (!existingMarker) {
            const textX = document.createElementNS("http://www.w3.org/2000/svg", "text");
            textX.classList.add('completed-marker');
            textX.setAttribute('x', 0);
            textX.setAttribute('y', 4);
            textX.textContent = '✖';
            group.appendChild(textX);
          }
        } else {
          if (existingMarker) group.removeChild(existingMarker);
        }
      });

      if (completedRegions.length > 0 && completedRegions.length === total) {
        showConfirm("Hai completato tutte le regioni. Resettare il progresso?").then(conf => {
          if (conf) {
            completedRegions = [];
            saveCompletedRegionsLocal();
            if (multiplayerEnabled && window.MP?.isAdmin) {
              window.mpUpdateRoom({ completedRegions }).catch(console.warn);
            }
            updateMapProgressVisual();
          }
        });
      }
    }

    function markRegionCompleted(regionCode) {
      if (!completedRegions.includes(regionCode)) {
        completedRegions.push(regionCode);
        saveCompletedRegionsLocal();
        updateMapProgressVisual();

        if (multiplayerEnabled && window.MP?.isAdmin) {
          window.mpUpdateRoom({ completedRegions }).catch(console.warn);
        }
      }
    }

    // ================= QUIZ =================
    function startQuizForRegion(regionCode, regionName) {
      if (!adminOnline) return showAlert("Gioco non attivo: attendi che l'admin avvii la sessione.");
      if (selectedPlayers.size === 0) return showAlert("Seleziona almeno un giocatore per giocare.");

      const currentName = turnOrder[currentTurnIndex];
      currentPlayer = participants.find(p => p.nickname === currentName);
      if (!currentPlayer) return showAlert("Giocatore selezionato non trovato.");

      currentRegionCode = regionCode;
      currentRegionName = regionName;
      const num = getRegionNumber(regionCode);

      showAlert(`Hai scelto ${num}. ${regionName}`).then(() => {
        const quizEntry = quizData[regionCode];
        if (!quizEntry || !Array.isArray(quizEntry.questions) || quizEntry.questions.length === 0) {
          quizContent.innerHTML = "<p>Nessun quiz disponibile per questa regione.</p>";
          prevBtn.style.display = 'none';
          nextBtn.style.display = 'none';
          quizImage.style.display = 'none';
          if (quizTimerElem) quizTimerElem.style.display = 'none';
          quizModal.classList.add('active');
          return;
        }

        currentQuestionIndex = 0;
        userAnswers = new Array(quizEntry.questions.length).fill(null);
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        if (quizTimerElem) {
          quizTimerElem.textContent = '';
          quizTimerElem.style.display = 'block';
        }

        showQuestion();

        const imgUrl = imagesData[regionCode];
        if (imgUrl && imgUrl.trim() !== "") {
          quizImage.src = imgUrl;
          quizImage.alt = regionName;
          quizImage.style.display = 'block';
        } else {
          quizImage.style.display = 'none';
        }

        quizFeedback.textContent = "";
        quizModal.classList.add('active');
      });
    }

    function showQuestion() {
      if (quizIntervalId !== null) { clearInterval(quizIntervalId); quizIntervalId = null; }

      quizTimeRemaining = quizTimeLimit;
      if (quizTimerElem) {
        quizTimerElem.textContent = `Tempo rimasto: ${quizTimeRemaining}s`;
        quizTimerElem.style.color = '';
      }

      const questions = quizData[currentRegionCode].questions;
      const total = questions.length;
      const q = questions[currentQuestionIndex];

      quizContent.innerHTML = '';

      const num = getRegionNumber(currentRegionCode);
      const regionHeader = document.createElement('div');
      regionHeader.className = 'quiz-region-title';
      regionHeader.textContent = `${num}. ${currentRegionName}`;
      quizContent.appendChild(regionHeader);

      if (q.imageUrl) {
        const qImg = document.createElement('img');
        qImg.src = q.imageUrl;
        qImg.alt = "Immagine domanda";
        qImg.style.maxWidth = "100%";
        qImg.style.borderRadius = "8px";
        qImg.style.marginBottom = "8px";
        quizContent.appendChild(qImg);
      }

      const titleP = document.createElement('p');
      titleP.innerHTML = `<strong>Domanda ${currentQuestionIndex+1} di ${total}</strong>`;
      quizContent.appendChild(titleP);

      const questionP = document.createElement('p');
      questionP.textContent = q.question;
      quizContent.appendChild(questionP);

      q.answers.forEach((a, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = a;
        btn.className = 'answer-btn';

        if (userAnswers[currentQuestionIndex] !== null) {
          if (i === userAnswers[currentQuestionIndex]) btn.classList.add(i === q.correct ? 'correct' : 'wrong');
          btn.disabled = true;
        }
        btn.addEventListener('click', () => selectAnswer(i));
        quizContent.appendChild(btn);
      });

      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.textContent = (currentQuestionIndex === total - 1) ? "Termina" : "Successiva";

      quizIntervalId = setInterval(() => {
        quizTimeRemaining--;
        if (quizTimerElem) {
          quizTimerElem.textContent = `Tempo rimasto: ${quizTimeRemaining}s`;
          quizTimerElem.style.color = (quizTimeRemaining <= 5) ? '#ff4444' : '';
        }
        if (quizTimeRemaining <= 0) {
          clearInterval(quizIntervalId);
          quizIntervalId = null;

          const buttons = quizContent.querySelectorAll('.answer-btn');
          buttons.forEach(btn => btn.disabled = true);
          buttons.forEach((btn, idx) => { if (idx === q.correct) btn.classList.add('correct'); });
          quizFeedback.textContent = 'Tempo scaduto!';

          setTimeout(() => nextBtnHandler(), 1000);
        }
      }, 1000);
    }

    function selectAnswer(selectedIndex) {
      if (quizIntervalId !== null) { clearInterval(quizIntervalId); quizIntervalId = null; }

      userAnswers[currentQuestionIndex] = selectedIndex;
      const buttons = quizContent.querySelectorAll('.answer-btn');
      const correct = quizData[currentRegionCode].questions[currentQuestionIndex].correct;

      buttons.forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === correct) btn.classList.add('correct');
        else if (idx === selectedIndex) btn.classList.add('wrong');
      });
    }

    function nextBtnHandler() {
      const questions = quizData[currentRegionCode].questions;
      const totalQuestions = questions.length;

      if (currentQuestionIndex < totalQuestions - 1) {
        currentQuestionIndex++;
        showQuestion();
        return;
      }

      let correctCount = 0;
      userAnswers.forEach((ans, idx) => { if (ans === questions[idx].correct) correctCount++; });

      quizFeedback.textContent = `Hai risposto correttamente a ${correctCount} su ${totalQuestions} domande.`;

      const playerName = turnOrder[currentTurnIndex];
      const playerObj = participants.find(p => p.nickname === playerName);
      if (!playerObj) {
        showAlert("Errore: giocatore non trovato.").then(() => nextPlayerTurn());
        return;
      }

      if (correctCount >= 3) playerObj.wins++;
      else playerObj.losses++;
      playerObj.games++;

      saveParticipantsAndMaybeRemote();
      updateLeaderboard();
      updatePlayerList();

      clearInterval(quizIntervalId);
      quizIntervalId = null;
      if (quizTimerElem) quizTimerElem.textContent = '';
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';

      if (correctCount >= 3) {
        showAlert(`Complimenti ${playerObj.nickname}, hai vinto il quiz su ${getRegionNumber(currentRegionCode)}. ${currentRegionName}!`)
          .then(() => showConfirm(`Vuoi aprire il pacco per la regione ${getRegionNumber(currentRegionCode)}. ${currentRegionName}?`))
          .then(open => { if (open) showPaccoAfterQuiz(currentRegionCode, currentRegionName); else nextPlayerTurn(); });
      } else {
        showAlert(`Mi dispiace, non hai superato il quiz e non puoi aprire il pacco.`)
          .then(() => nextPlayerTurn());
      }
    }

    function showPaccoAfterQuiz(regionCode, regionName) {
      quizModal.classList.remove('active');
      showPaccoModal(regionCode, regionName);
    }

    // ================= PACCHI =================
    function startPacchiForRegion(regionCode, regionName) {
      if (!adminOnline) return showAlert("Gioco non attivo: attendi che l'admin avvii la sessione.");
      if (!turnOrder || turnOrder.length===0) return showAlert("Seleziona almeno un giocatore per iniziare.");
      currentRegionCode = regionCode;
      currentRegionName = regionName;
      showPaccoModal(regionCode, regionName);
    }

    function showPaccoModal(regionCode, regionName) {
      if (!turnOrder || turnOrder.length===0) return showAlert("Seleziona almeno un giocatore prima.");

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.style.zIndex = 4000;

      const box = document.createElement('div');
      box.className = 'modal-box';

      const styleBlock = document.createElement('style');
      styleBlock.textContent = `
        @keyframes blinkFastLocal {
          0%,100% { opacity: 1; color: #ff0; text-shadow: 0 0 10px #ff0; }
          50% { opacity: 0.5; color: #f00; text-shadow: 0 0 20px #f00; }
        }
        .pacco-title { font-size: 2rem; margin-bottom: 1rem; animation: blinkFastLocal 0.8s infinite alternate; text-align: center; }
        .pacco-text { font-size: 1.2rem; margin-bottom: 1rem; text-align: center; }
        .pacco-image { max-width: 80%; max-height: 200px; margin: 0 auto 1rem auto; display: block; }
      `;
      box.appendChild(styleBlock);

      const regionObj = pacchiData[regionCode] || {};
      const textPack = regionObj.pack || "Pacco non disponibile.";
      const effectObj = regionObj.effect || { type: "none" };

      const titleEl = document.createElement('div');
      titleEl.className = 'pacco-title';
      titleEl.textContent = `${getRegionNumber(regionCode)}. ${regionName}`;
      box.appendChild(titleEl);

      let imgUrl = null;
      if (effectObj.type === 'image' && effectObj.url) imgUrl = effectObj.url;
      else if (regionObj.imageUrl) imgUrl = regionObj.imageUrl;

      if (imgUrl) {
        const imgEl = document.createElement('img');
        imgEl.src = imgUrl;
        imgEl.alt = 'Immagine pacco';
        imgEl.className = 'pacco-image';
        imgEl.onerror = () => { imgEl.style.display = 'none'; };
        box.appendChild(imgEl);
      }

      const textEl = document.createElement('div');
      textEl.className = 'pacco-text';
      textEl.textContent = textPack;
      box.appendChild(textEl);

      const feedbackEl = document.createElement('div');
      feedbackEl.className = 'pacco-text';

      const currentName = turnOrder[currentTurnIndex];
      const currentPlayerObj = participants.find(p => p.nickname === currentName);

      if (!currentPlayerObj) {
        feedbackEl.textContent = "Errore: giocatore non trovato.";
      } else {
        let feedbackMsg = "";
        let skipNext = false;
        let extraTurn = false;

        switch (effectObj.type) {
          case 'score': {
            const delta = Number(effectObj.delta) || 0;
            currentPlayerObj.score = (currentPlayerObj.score || 0) + delta;
            const cur = effectObj.currency || 'punti';
            feedbackMsg = delta>=0 ? `Hai guadagnato ${delta} ${cur}!` : `Hai perso ${Math.abs(delta)} ${cur}!`;
            break;
          }
          case 'skipTurn':
            skipNext = true;
            feedbackMsg = "Salti il prossimo turno!";
            break;
          case 'extraTurn':
            extraTurn = true;
            feedbackMsg = "Hai un turno extra!";
            break;
          case 'quizHint':
            feedbackMsg = `Suggerimento: ${effectObj.hint || ''}`;
            break;
          case 'none':
            feedbackMsg = "Nessun effetto aggiuntivo.";
            break;
          default:
            feedbackMsg = effectObj.message || "Effetto sconosciuto.";
        }

        feedbackEl.textContent = feedbackMsg;

        saveParticipantsAndMaybeRemote();
        updateLeaderboard();
        updatePlayerList();
        markRegionCompleted(regionCode);

        if (skipNext) currentTurnIndex = (currentTurnIndex + 2) % turnOrder.length;
        else if (!extraTurn) currentTurnIndex = (currentTurnIndex + 1) % turnOrder.length;

        updateTurnIndicator();
        if (multiplayerEnabled && window.MP?.isAdmin) {
          window.mpUpdateRoom({ currentTurnIndex }).catch(console.warn);
        }
      }

      box.appendChild(feedbackEl);

      const btnContainer = document.createElement('div');
      btnContainer.className = 'modal-buttons';
      const okBtn = document.createElement('button');
      okBtn.type='button';
      okBtn.textContent = 'OK';
      okBtn.addEventListener('click', () => { document.body.removeChild(overlay); });
      btnContainer.appendChild(okBtn);
      box.appendChild(btnContainer);

      overlay.appendChild(box);
      document.body.appendChild(overlay);
      setTimeout(() => { okBtn.focus(); }, 0);
    }

    // ================= PACCHI EDITOR =================
    function renderPacchiEditor() {
      const pacchiListContainer = document.getElementById('pacchi-list-container');
      pacchiListContainer.innerHTML = '';
      Object.keys(pacchiData).forEach(regionCode => {
        const regionObj = pacchiData[regionCode] || {};
        const regionName = regionObj.region || "";
        const num = regionNumbers[regionCode] || "";

        const container = document.createElement('div');
        container.style.marginBottom = '20px';
        container.innerHTML = `
          <label><strong>${num}. ${regionName}</strong></label>
          <p style="margin: 4px 0 2px;">Testo Pacco:</p>
          <textarea data-region="${regionCode}" class="pacco-textarea" placeholder="Testo pacco"
            style="width:100%; height:60px; font-family: monospace;">${regionObj.pack || ''}</textarea>

          <p style="margin: 4px 0 2px;">Effetto (JSON):</p>
          <textarea data-region-effect="${regionCode}" class="pacco-effect-textarea" placeholder='{"type":"score","delta":2}'
            style="width:100%; height:60px; font-family: monospace;">${regionObj.effect ? JSON.stringify(regionObj.effect) : ''}</textarea>

          <p style="margin: 4px 0 2px;">URL Immagine Pacco (opzionale):</p>
          <input type="text" data-region-image="${regionCode}" placeholder="https://esempio.com/immagine.jpg"
            value="${regionObj.imageUrl || ''}" style="width:100%; font-family: monospace; margin-bottom:8px;" />
        `;

        const textArea = container.querySelector(`.pacco-textarea`);
        const effectArea = container.querySelector(`.pacco-effect-textarea`);
        const imgInput = container.querySelector(`input[data-region-image="${regionCode}"]`);

        textArea.addEventListener('input', () => {
          pacchiData[regionCode] = pacchiData[regionCode] || { region: regionName, pack: '', effect: { type: "none" } };
          pacchiData[regionCode].pack = textArea.value.trim();
        });

        effectArea.addEventListener('input', () => {
          pacchiData[regionCode] = pacchiData[regionCode] || { region: regionName, pack: '', effect: { type: "none" } };
          try { pacchiData[regionCode].effect = JSON.parse(effectArea.value.trim()); } catch(_) {}
        });

        imgInput.addEventListener('input', () => {
          pacchiData[regionCode] = pacchiData[regionCode] || { region: regionName, pack: '', effect: { type: "none" } };
          const url = imgInput.value.trim();
          if (url) pacchiData[regionCode].imageUrl = url;
          else delete pacchiData[regionCode].imageUrl;
        });

        pacchiListContainer.appendChild(container);
      });
    }

    function renderImagesEditor() {
      imagesListContainer.innerHTML='';
      Object.keys(defaultImagesData).forEach(regionCode => {
        const regionName = quizData[regionCode]?.region || "";
        const num = regionNumbers[regionCode] || "";
        const container = document.createElement('div');
        container.style.marginBottom='15px';
        container.innerHTML=`
          <label><strong>${num}. ${regionName}</strong></label>
          <input type="text" data-region="${regionCode}" placeholder="URL immagine" value="${imagesData[regionCode]||''}" class="modal-input" />
          <img src="${imagesData[regionCode]||''}" alt="${regionName}" onerror="this.style.display='none'"
               style="max-width:100px; display:${imagesData[regionCode]?'block':'none'};" />
        `;
        const input=container.querySelector('input');
        const img=container.querySelector('img');
        input.addEventListener('input',()=>{
          img.src=input.value.trim();
          img.style.display=input.value.trim()?'block':'none';
        });
        imagesListContainer.appendChild(container);
      });
    }

    function renderNumbersHelper() {
      numbersHelperDiv.innerHTML = '';
      Object.entries(regionNumbers).forEach(([regionCode, num]) => {
        const regionName = getRegionName(regionCode);
        const p = document.createElement('p');
        p.style.margin = '2px 0';
        p.textContent = `${num}. ${regionName}`;
        numbersHelperDiv.appendChild(p);
      });
    }

    // ================= GAME MODE =================
    function applyGameModeToUI() {
      gameModeRadios.forEach(r => { r.checked = (r.value === gameMode); });
    }

    // ================= WIKI PACCHI =================
    const regionInfoList = [
      { code: "IT-25", name: "Piemonte" },
      { code: "IT-23", name: "Valle d’Aosta" },
      { code: "IT-42", name: "Liguria" },
      { code: "IT-21", name: "Lombardia" },
      { code: "IT-32", name: "Trentino-Alto Adige" },
      { code: "IT-34", name: "Veneto" },
      { code: "IT-45", name: "Friuli-Venezia Giulia" },
      { code: "IT-36", name: "Emilia-Romagna" },
      { code: "IT-52", name: "Toscana" },
      { code: "IT-55", name: "Umbria" },
      { code: "IT-57", name: "Marche" },
      { code: "IT-62", name: "Lazio" },
      { code: "IT-67", name: "Abruzzo" },
      { code: "IT-65", name: "Molise" },
      { code: "IT-72", name: "Campania" },
      { code: "IT-75", name: "Puglia" },
      { code: "IT-77", name: "Basilicata" },
      { code: "IT-78", name: "Calabria" },
      { code: "IT-88", name: "Sicilia" },
      { code: "IT-82", name: "Sardegna" }
    ];

    async function fetchRegionExternalData(regionName) {
      const safeName = regionName.replace(/[\u2018\u2019]/g, "'").replace(/ /g, '_');
      const endpoint = `https://it.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(safeName)}`;
      try {
        const resp = await fetch(endpoint);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        return { extract: data.extract || "", thumbnailUrl: data.thumbnail?.source || "" };
      } catch (e) {
        console.warn(`Errore fetch Wikipedia per ${regionName}:`, e);
        return {};
      }
    }

    async function generateOnlinePacchiForAllRegions() {
      for (const reg of regionInfoList) {
        try {
          const dataRec = await fetchRegionExternalData(reg.name);
          let packText = dataRec.extract ? `Scopri: ${(dataRec.extract.length>200 ? dataRec.extract.slice(0,197)+'...' : dataRec.extract)}` : `Pacco avanzato per ${reg.name}`;
          const delta = Math.floor(Math.random() * 5) + 1;
          const obj = { region: reg.name, pack: packText, effect: { type: "score", delta } };
          if (dataRec.thumbnailUrl) obj.imageUrl = dataRec.thumbnailUrl;
          pacchiData[reg.code] = obj;
        } catch (e) {
          console.warn(`Errore generazione online per ${reg.name}`, e);
        }
        await new Promise(res => setTimeout(res, 200));
      }
      savePacchiDataLocal(pacchiData);
      saveRemoteData(PACCHI_DATA_SAVE_URL, pacchiData).catch(err => console.warn("Pacchi online salvataggio remoto fallito", err));
      await showAlert('Pacchi avanzati generati per tutte le regioni e salvati.');
      positionClock();
    }

    function generateOfflinePacchiForAllRegions() {
      Object.keys(pacchiData).forEach(regionCode => {
        const regionName = quizData[regionCode]?.region || regionCode;
        pacchiData[regionCode] = { region: regionName, pack: `Pacco offline per ${regionName}`, effect: { type: "score", delta: 1 } };
      });
      savePacchiDataLocal(pacchiData);
      saveRemoteData(PACCHI_DATA_SAVE_URL, pacchiData).catch(err => console.warn("Pacchi offline salvataggio remoto fallito", err));
      showAlert('Pacchi offline generati per tutte le regioni e salvati.').then(()=>positionClock());
    }

    // ================= PLAYER LIST =================
    function updatePlayerList() {
      playerList.innerHTML = '';
      participants.forEach(p => {
        const li = document.createElement('li');
        li.style.padding='4px 6px';
        li.style.borderBottom='1px solid #004466';
        li.style.display='flex';
        li.style.alignItems='center';
        li.style.justifyContent='space-between';

        const leftContainer = document.createElement('div');
        leftContainer.style.display='flex';
        leftContainer.style.alignItems='center';

        const checkbox = document.createElement('input');
        checkbox.type='checkbox';
        checkbox.id=`player-checkbox-${p.nickname}`;
        checkbox.value=p.nickname;
        checkbox.checked = selectedPlayers.has(p.nickname);

        const label = document.createElement('label');
        label.htmlFor=checkbox.id;
        label.textContent=p.nickname;
        label.style.cursor='pointer';
        label.style.marginLeft='6px';

        checkbox.addEventListener('change', () => {
          if (checkbox.checked) selectedPlayers.add(p.nickname);
          else selectedPlayers.delete(p.nickname);
          updateSelectedPlayersInfo();
          saveSelectedPlayersLocal();
          updateTurnOrder(); // include sync multiplayer if admin
        });

        leftContainer.appendChild(checkbox);
        leftContainer.appendChild(label);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent='✖';
        deleteBtn.title='Cancella questo nickname';
        deleteBtn.style.background='transparent';
        deleteBtn.style.border='none';
        deleteBtn.style.color='#ff4444';
        deleteBtn.style.fontWeight='700';
        deleteBtn.style.cursor='pointer';
        deleteBtn.style.fontSize='1.1rem';
        deleteBtn.style.padding='0 6px';
        deleteBtn.addEventListener('click', () => {
          showConfirm(`Sei sicuro di cancellare il nickname "${p.nickname}"?`).then(conf => {
            if (conf) deleteParticipant(p.nickname);
          });
        });

        li.appendChild(leftContainer);
        li.appendChild(deleteBtn);
        playerList.appendChild(li);
      });

      updateSelectedPlayersInfo();
      closeRegisterBtn.disabled = participants.length === 0;
    }

    function deleteParticipant(nickname) {
      const index = participants.findIndex(p => p.nickname.toLowerCase()===nickname.toLowerCase());
      if (index!==-1) {
        participants.splice(index,1);
        saveParticipantsAndMaybeRemote();
        updateLeaderboard();
        updatePlayerList();
        if (selectedPlayers.has(nickname)) {
          selectedPlayers.delete(nickname);
          saveSelectedPlayersLocal();
          updateTurnOrder();
        }
        showAlert(`Nickname "${nickname}" cancellato con successo.`).then(()=>positionClock());
      } else {
        showAlert(`Nickname "${nickname}" non trovato.`).then(()=>positionClock());
      }
    }

    // ================= REGION QUESTIONS GENERATOR =================
    // (in questa versione mantengo il tuo auto-generatore già presente: lo lasciamo invariato dove possibile)
    // Nota: per brevità l'oggetto regionStaticData è grande; lo manteniamo come nel tuo file originale quando lo incolli nel progetto.
    // Qui inseriamo un fallback minimo per non rompere nulla, ma puoi sostituirlo con il tuo regionStaticData completo.
    const regionStaticData = {}; // <-- se vuoi, incolla qui il tuo enorme oggetto (quello che avevi)

    function generateQuestionsForAllRegions() {
      // se non hai regionStaticData completo, genera almeno 1 domanda semplice per regione
      const allGenerated = {};
      Object.entries(defaultQuizData).forEach(([code, meta]) => {
        allGenerated[code] = {
          region: meta.region,
          questions: [
            {
              question: `Seleziona la regione: ${meta.region}`,
              answers: shuffleArray([meta.region, "Risposta B", "Risposta C"]),
              correct: 0
            }
          ]
        };
      });
      return allGenerated;
    }

    function ensureQuizDataPopulatedIfEmpty() {
      const codes = Object.keys(defaultQuizData);
      let emptyCount = 0;
      codes.forEach(code => {
        const entry = quizData[code];
        if (!entry || !Array.isArray(entry.questions) || entry.questions.length === 0) emptyCount++;
      });
      if (emptyCount >= codes.length/2) {
        const generated = generateQuestionsForAllRegions();
        quizData = generated;
        saveQuizDataLocal(quizData);
        saveRemoteData(QUIZ_DATA_SAVE_URL, quizData).catch(()=>{});
      }
    }

    // ================= CLOCK =================
    function twoDigits(num) { return String(num).padStart(2, '0'); }
    function getCurrentTimeString() {
      const now = new Date();
      return `${twoDigits(now.getHours())}:${twoDigits(now.getMinutes())}:${twoDigits(now.getSeconds())}`;
    }
    function updateClock() {
      const clockDiv = document.getElementById('real-time-clock');
      if (clockDiv) clockDiv.textContent = getCurrentTimeString();
    }
    function positionClock() {
      const clockDiv = document.getElementById('real-time-clock');
      if (!clockDiv) return;

      const selectors = ['#admin-status', '#toggle-players-btn', '#player-selection'];
      let maxBottom = 0;
      selectors.forEach(sel => {
        const el = document.querySelector(sel);
        if (!el) return;
        const style = window.getComputedStyle(el);
        if (style.display === 'none' || style.visibility === 'hidden') return;
        const rect = el.getBoundingClientRect();
        if (rect.bottom > maxBottom) maxBottom = rect.bottom;
      });

      const margin = 10;
      clockDiv.style.top = `${maxBottom + margin}px`;
    }
    function initRealTimeClock() {
      updateClock();
      positionClock();
      setInterval(updateClock, 1000);
      window.addEventListener('resize', positionClock);
      if (togglePlayersBtn) togglePlayersBtn.addEventListener('click', () => setTimeout(positionClock, 20));
    }

    // ================= MULTIPLAYER LISTENERS (ONCE) =================
    window.addEventListener("mp-room", (ev) => {
      multiplayerEnabled = true;
      roomState = ev.detail.data;

      // admin online: NON sync back (evita loop)
      setAdminOnline(!!roomState.adminOnline, false);

      // mode + timer da stanza
      if (roomState.gameMode === "quiz" || roomState.gameMode === "pacchi") {
        gameMode = roomState.gameMode;
        applyGameModeToUI();
      }
      if (typeof roomState.quizTimeLimit === "number") {
        quizTimeLimit = roomState.quizTimeLimit;
        const input = document.getElementById("quiz-time-input");
        if (input) input.value = quizTimeLimit;
      }

      // selezioni / turni / completate
      if (Array.isArray(roomState.selectedPlayers)) {
        selectedPlayers = new Set(roomState.selectedPlayers);
        updatePlayerList();
        updateSelectedPlayersInfo();
      }
      if (Array.isArray(roomState.turnOrder)) {
        turnOrder = roomState.turnOrder.slice();
      }
      if (typeof roomState.currentTurnIndex === "number") {
        currentTurnIndex = roomState.currentTurnIndex;
      }
      updateTurnIndicator();

      if (Array.isArray(roomState.completedRegions)) {
        completedRegions = roomState.completedRegions.slice();
        saveCompletedRegionsLocal();
        updateMapProgressVisual();
      }

      const status = document.getElementById("room-status");
      if (status) status.textContent = `Connesso alla stanza: ${ev.detail.roomCode}${(window.MP?.isAdmin) ? " (ADMIN)" : ""}`;
    });

    window.addEventListener("mp-players", (ev) => {
      multiplayerEnabled = true;
      participants = (ev.detail.players || []).map(p => ({
        nickname: p.nickname,
        score: p.score || 0,
        wins: p.wins || 0,
        losses: p.losses || 0,
        games: p.games || 0,
        uid: p.uid
      }));
      updateLeaderboard();
      updatePlayerList();
    });

    // ================= BOOT =================
    window.addEventListener('DOMContentLoaded', () => {
      initRealTimeClock();

      // timer input init + save handler
      const input = document.getElementById('quiz-time-input');
      if (input) input.value = quizTimeLimit;

      const saveBtn = document.getElementById('save-quiz-time-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          const inputEl = document.getElementById('quiz-time-input');
          const msgEl   = document.getElementById('quiz-time-msg');
          if (!inputEl || !msgEl) return;

          const v = parseInt(inputEl.value, 10);
          if (isNaN(v) || v < 5) {
            msgEl.style.color = '#ff4444';
            msgEl.textContent = 'Inserisci un numero ≥ 5';
            return;
          }

          quizTimeLimit = v;
          saveToLocal('quizTimeLimit', v);

          msgEl.style.color = '#22cc88';
          msgEl.textContent = `Timer impostato a ${v}s`;
          setTimeout(() => { msgEl.textContent = ''; }, 2000);

          // Multiplayer: solo ADMIN aggiorna la stanza
          if (multiplayerEnabled && window.MP?.isAdmin) {
            window.mpUpdateRoom({ quizTimeLimit: v }).catch(console.warn);
          }
        });
      }

      // load data
      loadLocalData();
      loadRemoteData().then(() => {
        ensureQuizDataPopulatedIfEmpty();
        updateLeaderboard();
        updatePlayerList();
        updateRegionNumbers(regionNumbers);
        updateMapProgressVisual();
        applyGameModeToUI();
        updateTurnOrder(); // local + eventual sync admin
        setAdminOnline(false, false);
        updateAdminLoginBtn();
        positionClock();
      });
    });

    // ================= EVENTS =================
    adminLoginBtn.addEventListener('click', () => {
      if (!adminOnline) {
        showPrompt("Inserisci password admin:").then(pwd => {
          if (pwd === ADMIN_PASSWORD) {
            setAdminOnline(true, true);
            showAlert("Accesso admin riuscito: gioco attivo.").then(()=>positionClock());
          } else if (pwd !== null) {
            showAlert("Password errata. Accesso negato.").then(()=>positionClock());
          }
        });
      } else {
        setAdminOnline(false, true);
        showAlert("Logout admin eseguito: gioco disattivato.").then(()=>positionClock());
      }
    });

    togglePlayersBtn.addEventListener('click', () => {
      if (playerSelectionDiv.classList.contains('hidden')) {
        playerSelectionDiv.classList.remove('hidden');
        togglePlayersBtn.textContent = 'Nascondi Giocatori';
      } else {
        playerSelectionDiv.classList.add('hidden');
        togglePlayersBtn.textContent = 'Mostra Giocatori';
      }
      positionClock();
    });

    resetSelectionBtn.addEventListener('click', () => {
      selectedPlayers.clear();
      playerList.querySelectorAll('input[type="checkbox"]').forEach(inp => inp.checked = false);
      updateSelectedPlayersInfo();
      saveSelectedPlayersLocal();
      updateTurnOrder();
      positionClock();
    });

    menuToggleBtn.addEventListener('click', () => {
      menuContainer.style.display = (menuContainer.style.display === 'block') ? 'none' : 'block';
      positionClock();
    });
    document.addEventListener('click', (e) => {
      if (!menuContainer.contains(e.target) && e.target !== menuToggleBtn) menuContainer.style.display = 'none';
    });

    // game mode change (una sola volta)
    gameModeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (!radio.checked) return;
        gameMode = radio.value;
        saveGameModeLocal();
        applyGameModeToUI();

        if (multiplayerEnabled && window.MP?.isAdmin) {
          window.mpUpdateRoom({ gameMode }).catch(console.warn);
        }
      });
    });

    // register form
    function addOrUpdateParticipant(nickname) {
      const existing = participants.find(p => p.nickname.toLowerCase() === nickname.toLowerCase());
      if (existing) {
        if (typeof existing.wins !== 'number') existing.wins = 0;
        if (typeof existing.losses !== 'number') existing.losses = 0;
        if (typeof existing.games !== 'number') existing.games = 0;
        if (typeof existing.score !== 'number') existing.score = 0;
      } else {
        participants.push({ nickname, wins: 0, losses: 0, games: 0, score: 0 });
      }
      saveParticipants();
      updateLeaderboard();
      updatePlayerList();
      closeRegisterBtn.disabled = participants.length === 0;
    }

    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const nickname = registerForm.nickname.value.trim();
      if (!nickname) {
        registerMsg.style.color = '#ff4444';
        registerMsg.textContent = 'Inserisci un nickname valido.';
        return;
      }
      addOrUpdateParticipant(nickname);
      registerMsg.style.color = '#22cc88';
      registerMsg.textContent = `Nickname "${nickname}" registrato.`;
      setTimeout(() => { registerMsg.textContent = ''; }, 2000);
      positionClock();
    });

    closeRegisterBtn.addEventListener('click', () => { registerModal.classList.remove('active'); positionClock(); });
    openRegisterBtn.addEventListener('click', () => { registerModal.classList.add('active'); positionClock(); });

    // quiz controls
    nextBtn.addEventListener('click', nextBtnHandler);
    prevBtn.addEventListener('click', () => {
      if (currentQuestionIndex > 0) { currentQuestionIndex--; showQuestion(); }
    });
    closeQuizBtn.addEventListener('click', () => {
      quizModal.classList.remove('active');
      if (quizIntervalId !== null) { clearInterval(quizIntervalId); quizIntervalId = null; }
      quizFeedback.textContent = '';
      if (quizTimerElem) quizTimerElem.textContent = '';
      nextBtn.style.display = 'inline-block';
      prevBtn.style.display = 'inline-block';
    });

    // map click
    svg.querySelectorAll('g').forEach(group => {
      group.addEventListener('click', () => {
        if (!adminOnline) return showAlert("Gioco non attivo: attendi che l'admin avvii la sessione.");
        const regionCode = group.dataset.regionCode;
        const regionName = group.dataset.regionName;
        if (!regionCode) return;

        // toggle completamento locale + sync admin
        if (completedRegions.includes(regionCode)) {
          completedRegions = completedRegions.filter(c => c !== regionCode);
          saveCompletedRegionsLocal();
          updateMapProgressVisual();
          if (multiplayerEnabled && window.MP?.isAdmin) {
            window.mpUpdateRoom({ completedRegions }).catch(console.warn);
          }
          return;
        }

        if (gameMode === 'quiz') startQuizForRegion(regionCode, regionName);
        else startPacchiForRegion(regionCode, regionName);
      });
    });

    // host/join multiplayer
    const hostBtn = document.getElementById("host-room-btn");
    const joinBtn = document.getElementById("join-room-btn");
    const roomCodeInput = document.getElementById("room-code-input");

    if (hostBtn && joinBtn && roomCodeInput) {
      hostBtn.addEventListener("click", async () => {
        const nick = document.getElementById("nickname").value.trim();
        if (!nick) return showAlert("Inserisci prima un nickname.");
        try {
          const code = await window.mpHostRoom(nick, { gameMode, quizTimeLimit });
          roomCodeInput.value = code;
          showAlert(`Stanza creata! Room code: ${code}\nCondividilo agli altri giocatori.`);
        } catch (e) {
          showAlert("Errore creazione stanza: " + e.message);
        }
      });

      joinBtn.addEventListener("click", async () => {
        const nick = document.getElementById("nickname").value.trim();
        const code = roomCodeInput.value.trim().toUpperCase();
        if (!nick) return showAlert("Inserisci prima un nickname.");
        if (!code) return showAlert("Inserisci un Room code.");
        try {
          await window.mpJoinRoom(code, nick);
          showAlert(`Sei entrato nella stanza: ${code}`);
        } catch (e) {
          showAlert("Errore JOIN: " + e.message);
        }
      });
    }

    // gestione esterna + popup
    externalManageBtn.addEventListener('click', () => {
      showPrompt("Inserisci la password per accedere alla gestione domande esterna:").then(pwd => {
        if (pwd === EXTERNAL_PASSWORD) window.open("https://alexcaos.altervista.org/REGIONI/RegioniItaliaQuiz/gestionedomande.html","_blank");
        else if (pwd !== null) showAlert("Password errata. Accesso negato.");
      });
    });

    archiveEventsBtn.addEventListener('click', () => {
      showPrompt("Inserisci la password per accedere all'Archivio Eventi:").then(pwd => {
        if (pwd === ADMIN_PASSWORD) window.open("https://alexcaos.altervista.org/NuovaCartella/Index.html","_blank","width=800,height=600");
        else if (pwd !== null) showAlert("Password errata. Accesso negato");
      });
    });

    documentsBtn.addEventListener('click', () => {
      showPrompt("Inserisci la password per accedere alla sezione Documenti:").then(pwd => {
        if (pwd === ADMIN_PASSWORD) window.open("https://alexcaos.altervista.org/REGIONI/RegioniItaliaQuiz/GestioneEsterna.html","_blank","width=800,height=600");
        else if (pwd !== null) showAlert("Password errata. Accesso negato");
      });
    });

    // admin modals (questions/images/numbers/pacchi) — qui manteniamo la tua logica base
    manageQuestionsBtn.addEventListener('click', () => {
      manageQuestionsModal.style.display='block';
      passwordSection.style.display='block';
      questionsEditorSection.style.display='none';
      manageQuestionsPasswordForm.reset();
      passwordMsgElem.textContent='';
      saveMsg.textContent='';
      setAdminOnline(false, false);
      positionClock();
      setTimeout(() => document.getElementById('admin-password')?.focus(), 0);
    });

    manageQuestionsPasswordForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const pwd = e.target.password.value;
      if (pwd === ADMIN_PASSWORD) {
        passwordSection.style.display='none';
        questionsEditorSection.style.display='block';
        questionsTextarea.value = JSON.stringify(quizData, null, 2);
        saveMsg.textContent='';
        setAdminOnline(true, true);
        positionClock();
        setTimeout(() => questionsTextarea.focus(), 0);
        passwordMsgElem.textContent = '';
      } else {
        passwordMsgElem.textContent='Password errata!';
        setAdminOnline(false, false);
        positionClock();
      }
    });

    generateAutoQuestionsBtn.addEventListener('click', () => {
      const generated = generateQuestionsForAllRegions();
      questionsTextarea.value = JSON.stringify(generated, null, 2);
      showAlert('Generazione automatica domande completata: verifica il JSON e poi salva.');
    });

    saveQuestionsBtn.addEventListener('click', () => {
      try {
        const newData = JSON.parse(questionsTextarea.value);
        quizData = newData;
        saveQuizDataLocal(newData);
        updateRegionNumbers(regionNumbers);
        updateMapProgressVisual();
        saveRemoteData(QUIZ_DATA_SAVE_URL, newData).catch(()=>{});
        saveMsg.style.color='#22cc88';
        saveMsg.textContent='Domande salvate con successo!';
      } catch (e) {
        saveMsg.style.color='#ff4444';
        saveMsg.textContent='Errore nel formato JSON: ' + e.message;
      }
    });

    resetDataBtn.addEventListener('click', () => {
      showConfirm("Sei sicuro di voler resettare tutti i dati partecipanti e domande al default?").then(conf => {
        if (!conf) return;
        participants = [];
        saveParticipantsAndMaybeRemote();
        quizData = defaultQuizData;
        saveQuizDataLocal(defaultQuizData);
        updateLeaderboard();
        updatePlayerList();
        updateRegionNumbers(regionNumbers);
        completedRegions = [];
        saveCompletedRegionsLocal();
        updateMapProgressVisual();
        saveMsg.style.color='#22cc88';
        saveMsg.textContent="Dati resettati al valore di default.";
        setTimeout(()=>{ saveMsg.textContent=''; }, 3000);
      });
    });

    closeManageBtn.addEventListener('click', () => {
      manageQuestionsModal.style.display='none';
      setAdminOnline(false, true);
      positionClock();
    });

    manageImagesBtn.addEventListener('click', () => {
      manageImagesModalElem.style.display='block';
      imagesPasswordSection.style.display='block';
      imagesEditorSection.style.display='none';
      manageImagesPasswordForm.reset();
      imagesPasswordMsgElem.textContent='';
      imagesSaveMsg.textContent='';
      setAdminOnline(false, false);
      positionClock();
      setTimeout(() => document.getElementById('images-admin-password')?.focus(), 0);
    });

    manageImagesPasswordForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const pwd = e.target.password.value;
      if (pwd === ADMIN_PASSWORD) {
        imagesPasswordSection.style.display='none';
        imagesEditorSection.style.display='block';
        renderImagesEditor();
        imagesSaveMsg.textContent='';
        setAdminOnline(true, true);
        positionClock();
        setTimeout(() => imagesListContainer.querySelector('input[type="text"]')?.focus(), 0);
      } else {
        imagesPasswordMsgElem.textContent='Password errata!';
        setAdminOnline(false, false);
        positionClock();
      }
    });

    saveImagesBtn.addEventListener('click', () => {
      const inputs=imagesListContainer.querySelectorAll('input[type="text"]');
      inputs.forEach(input => {
        const regionCode=input.getAttribute('data-region');
        imagesData[regionCode]=input.value.trim();
      });
      saveImagesDataLocal(imagesData);
      imagesSaveMsg.style.color='#22cc88';
      imagesSaveMsg.textContent='Immagini salvate con successo!';
    });

    closeImagesManageBtn.addEventListener('click', () => {
      manageImagesModalElem.style.display='none';
      setAdminOnline(false, true);
      positionClock();
    });

    manageNumbersBtn.addEventListener('click', () => {
      manageNumbersModalElem.style.display='block';
      numbersPasswordSection.style.display='block';
      numbersEditorSection.style.display='none';
      manageNumbersPasswordForm.reset();
      numbersPasswordMsgElem.textContent='';
      numbersSaveMsg.textContent='';
      setAdminOnline(false, false);
      positionClock();
      setTimeout(() => document.getElementById('numbers-admin-password')?.focus(), 0);
    });

    manageNumbersPasswordForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const pwd = e.target.password.value;
      if (pwd === ADMIN_PASSWORD) {
        numbersPasswordSection.style.display='none';
        numbersEditorSection.style.display='block';
        numbersTextarea.value=JSON.stringify(regionNumbers,null,2);
        renderNumbersHelper();
        numbersSaveMsg.textContent='';
        setAdminOnline(true, true);
        positionClock();
        setTimeout(() => numbersTextarea.focus(), 0);
      } else {
        numbersPasswordMsgElem.textContent='Password errata!';
        setAdminOnline(false, false);
        positionClock();
      }
    });

    document.getElementById('save-numbers-btn').addEventListener('click', () => {
      try {
        const newData=JSON.parse(numbersTextarea.value);
        regionNumbers=newData;
        saveRegionNumbersLocal(newData);
        updateRegionNumbers(regionNumbers);
        renderNumbersHelper();
        numbersSaveMsg.style.color='#22cc88';
        numbersSaveMsg.textContent='Numeri salvati con successo!';
      } catch(e) {
        numbersSaveMsg.style.color='#ff4444';
        numbersSaveMsg.textContent='Errore nel formato JSON: '+e.message;
      }
    });

    closeNumbersManageBtn.addEventListener('click', () => {
      manageNumbersModalElem.style.display='none';
      setAdminOnline(false, true);
      positionClock();
    });

    managePacchiBtn.addEventListener('click', () => {
      managePacchiModalElem.style.display='block';
      pacchiPasswordSectionElem.style.display='block';
      pacchiEditorSection.style.display='none';
      managePacchiPasswordForm.reset();
      pacchiPasswordMsgElem.textContent='';
      pacchiSaveMsgElem.textContent='';
      setAdminOnline(false, false);
      positionClock();
      setTimeout(() => document.getElementById('pacchi-admin-password')?.focus(), 0);
    });

    managePacchiPasswordForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const pwd = e.target.password.value;
      if (pwd === ADMIN_PASSWORD) {
        pacchiPasswordSectionElem.style.display='none';
        pacchiEditorSection.style.display='block';
        renderPacchiEditor();
        customPaccoFormDiv.style.display='none';
        pacchiSaveMsgElem.textContent='';
        setAdminOnline(true, true);
        positionClock();
        setTimeout(() => document.querySelector('#pacchi-list-container textarea')?.focus(), 0);
      } else {
        pacchiPasswordMsgElem.textContent='Password errata!';
        setAdminOnline(false, false);
        positionClock();
      }
    });

    importPacchiBtn.addEventListener('click', () => {
      const text = pacchiImportText.value.trim();
      if (!text) {
        pacchiImportMsg.style.color = '#ff4444';
        pacchiImportMsg.textContent = 'Textarea vuoto: inserisci codici pacco.';
        return setTimeout(() => pacchiImportMsg.textContent = '', 3000);
      }

      let importedCount = 0;

      try {
        const all = JSON.parse(text);
        if (typeof all === 'object' && all !== null) {
          for (const [id, parsed] of Object.entries(all)) {
            if (pacchiData[id]) {
              if (parsed.pack     !== undefined) pacchiData[id].pack     = parsed.pack;
              if (parsed.effect   !== undefined) pacchiData[id].effect   = parsed.effect;
              if (parsed.imageUrl !== undefined) pacchiData[id].imageUrl = parsed.imageUrl;
              importedCount++;
            }
          }
        }
      } catch (_) {
        text.split(/\r?\n/).forEach(line => {
          const [id, rest] = line.split('=');
          if (rest && pacchiData[id.trim()]) {
            try {
              const parsed = JSON.parse(rest.trim());
              if (parsed.pack     !== undefined) pacchiData[id.trim()].pack     = parsed.pack;
              if (parsed.effect   !== undefined) pacchiData[id.trim()].effect   = parsed.effect;
              if (parsed.imageUrl !== undefined) pacchiData[id.trim()].imageUrl = parsed.imageUrl;
              importedCount++;
            } catch (__){}
          }
        });
      }

      if (importedCount > 0) {
        pacchiImportMsg.style.color = '#22cc88';
        pacchiImportMsg.textContent = `Importati ${importedCount} pacchi correttamente.`;
        savePacchiDataLocal(pacchiData);
        renderPacchiEditor();
      } else {
        pacchiImportMsg.style.color = '#ff4444';
        pacchiImportMsg.textContent = 'Nessun codice valido importato: verifica ID regione e JSON.';
      }
      setTimeout(() => pacchiImportMsg.textContent = '', 3000);
    });

    savePacchiBtnElem.addEventListener('click', () => {
      savePacchiDataLocal(pacchiData);
      saveRemoteData(PACCHI_DATA_SAVE_URL, pacchiData).catch(()=>{});
      pacchiSaveMsgElem.style.color='#22cc88';
      pacchiSaveMsgElem.textContent='Pacchi salvati con successo!';
    });

    closePacchiManageBtn.addEventListener('click', () => {
      managePacchiModalElem.style.display='none';
      setAdminOnline(false, true);
      positionClock();
    });

    // pacchi generator buttons
    const generateOfflinePacchiBtn = document.getElementById('generate-offline-pacchi-btn');
    const generateOnlinePacchiBtn = document.getElementById('generate-online-pacchi-btn');
    if (generateOfflinePacchiBtn) {
      generateOfflinePacchiBtn.addEventListener('click', () => { generateOfflinePacchiForAllRegions(); renderPacchiEditor(); });
    }
    if (generateOnlinePacchiBtn) {
      generateOnlinePacchiBtn.addEventListener('click', async () => {
        generateOnlinePacchiBtn.disabled = true;
        if (generateOfflinePacchiBtn) generateOfflinePacchiBtn.disabled = true;
        await generateOnlinePacchiForAllRegions();
        renderPacchiEditor();
        generateOnlinePacchiBtn.disabled = false;
        if (generateOfflinePacchiBtn) generateOfflinePacchiBtn.disabled = false;
      });
    }

    // custom pacco form helpers
    function populateRegionSelect() {
      customRegionSelect.innerHTML = '';
      const entries = Object.entries(regionNumbers)
        .map(([code,num]) => ({ code, num: Number(num), name: quizData[code]?.region||code }))
        .sort((a,b)=>a.num-b.num);
      entries.forEach(e=>{
        const opt = document.createElement('option');
        opt.value = e.code;
        opt.textContent = `${e.num}. ${e.name}`;
        customRegionSelect.appendChild(opt);
      });
    }

    function updateEffectParams() {
      const t = customEffectTypeSelect.value;
      labelDelta.style.display = (t === 'score') ? 'block' : 'none';
      labelCurrency.style.display = (t === 'score') ? 'block' : 'none';
      labelCustomJson.style.display = (t === 'custom') ? 'block' : 'none';
    }

    openCustomPaccoFormBtn.addEventListener('click', () => {
      if (customPaccoFormDiv.style.display==='none') {
        populateRegionSelect();
        customPaccoFormDiv.style.display='block';
        customPaccoMsgDiv.textContent='';
        updateEffectParams();
      } else {
        customPaccoFormDiv.style.display='none';
      }
    });

    customEffectTypeSelect.addEventListener('change', updateEffectParams);

    addCustomPaccoBtn.addEventListener('click', () => {
      const regionCode = customRegionSelect.value;
      const packText = customPackTextInput.value.trim();
      if (!regionCode) {
        customPaccoMsgDiv.style.color='#ff4444';
        customPaccoMsgDiv.textContent='Seleziona una regione.';
        return;
      }
      if (!packText) {
        customPaccoMsgDiv.style.color='#ff4444';
        customPaccoMsgDiv.textContent='Inserisci descrizione pacco.';
        return;
      }

      let effectObj = {};
      const t = customEffectTypeSelect.value;
      try {
        if (t === 'score') {
          const deltaVal = Number(customDeltaInput.value);
          if (isNaN(deltaVal)) throw new Error('Delta non valido');
          effectObj.type = 'score';
          effectObj.delta = deltaVal;
          const cur = customCurrencyInput.value.trim();
          if (cur) effectObj.currency = cur;
        } else if (t === 'skipTurn') {
          effectObj = { type: 'skipTurn' };
        } else if (t === 'extraTurn') {
          effectObj = { type: 'extraTurn' };
        } else if (t === 'custom') {
          const txt = customJsonTextArea.value.trim();
          if (!txt) throw new Error('Inserisci JSON effetto.');
          effectObj = JSON.parse(txt);
        }
      } catch(e) {
        customPaccoMsgDiv.style.color='#ff4444';
        customPaccoMsgDiv.textContent = 'Errore effetto: ' + e.message;
        return;
      }

      const obj = { pack: packText, effect: effectObj };
      const line = `${regionCode}=${JSON.stringify(obj)}`;
      const prev = pacchiImportText.value.trim();
      pacchiImportText.value = prev ? (prev + '\n' + line) : line;

      customPaccoMsgDiv.style.color='#22cc88';
      customPaccoMsgDiv.textContent='Riga aggiunta al textarea. Clicca Importa codici per applicare.';
    });

    // turn indicator
    const turnIndicatorDiv = document.createElement('div');
    turnIndicatorDiv.id = 'turn-indicator';
    turnIndicatorDiv.style.cssText = `
      position: fixed; top: 10px; right: 50%; transform: translateX(50%);
      background: rgba(0,0,0,0.7); color: #fff; padding: 0.5rem 1rem;
      border-radius: 8px; font-weight: 700; z-index: 2500; display: none;
    `;
    turnIndicatorDiv.innerHTML = `Turno di: <span id="turn-player-name"></span>`;
    document.body.appendChild(turnIndicatorDiv);
  </script>
</body>
</html>
